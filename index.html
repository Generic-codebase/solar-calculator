<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Calculator Embed</title>
</head>
<body>

<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    .solar-calculator {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .calc-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        border-top: 4px solid #155263;
    }

    .calc-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .calc-title {
        font-size: 2rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    .calc-subtitle {
        color: #6b7280;
        font-size: 1rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #155263;
        box-shadow: 0 0 0 3px rgba(21, 82, 99, 0.1);
    }

    .form-input.error {
        border-color: #ef4444;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: none;
    }

    .error-message.show {
        display: block;
    }

    .tip-box {
        background-color: #f0f9ff;
        border: 1px solid #60e1e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .tip-box p {
        color: #052b2f;
        font-size: 0.875rem;
        margin: 0;
    }

    .results-section {
        display: none;
        margin-bottom: 2rem;
    }

    .results-section.show {
        display: block;
    }

    .result-card {
        background: linear-gradient(to right, #f0f9ff, #ffffff);
        border: 2px solid #60e1e0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .result-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    .result-text {
        color: #6b7280;
        margin-bottom: 0.75rem;
    }

    .result-note {
        color: #6b7280;
        font-size: 0.875rem;
        font-style: italic;
    }

    .status-icon {
        width: 3rem;
        height: 3rem;
        color: #96e0b3;
        flex-shrink: 0;
    }

    .power-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
        .power-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .power-card {
        padding: 1.5rem;
        border-radius: 8px;
        border: 2px solid;
    }

    .power-card.low {
        background-color: #eff6ff;
        border-color: #93c5fd;
    }

    .power-card.medium {
        background-color: #f0fdf4;
        border-color: #86efac;
    }

    .power-card.high {
        background-color: #fffef0;
        border-color: #ffc93c;
    }

    .power-header {
        font-size: 1.125rem;
        font-weight: 600;
        color: #155263;
        margin-bottom: 1rem;
    }

    .power-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .power-text {
        font-size: 1.875rem;
        font-weight: bold;
    }

    .power-text.low {
        color: #1e40af;
    }

    .power-text.medium {
        color: #15803d;
    }

    .power-text.high {
        color: #92400e;
    }

    .power-subtext {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .power-dot {
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .power-dot.low {
        background-color: #60a5fa;
    }

    .power-dot.medium {
        background-color: #4ade80;
    }

    .power-dot.high {
        background-color: #fbbf24;
    }

    .lvr-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 2px solid #155263;
    }

    .serviceability-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 2px solid #155263;
        margin-bottom: 2rem;
    }

    .service-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    @media (min-width: 768px) {
        .service-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .service-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        padding: 0.5rem 0;
    }

    .service-label {
        color: #6b7280;
    }

    .service-value {
        font-weight: 500;
    }

    .surplus-box {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .surplus-amount {
        font-size: 1.875rem;
        font-weight: bold;
    }

    .roi-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 2px solid #155263;
        margin-bottom: 2rem;
    }

    .roi-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (min-width: 768px) {
        .roi-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .roi-box {
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid;
    }

    .roi-box.blue {
        background-color: #f0f9ff;
        border-color: #60e1e0;
    }

    .roi-box.yellow {
        background-color: #fffef0;
        border-color: #ffc93c;
    }

    .roi-box.green {
        background-color: #f0fff4;
        border-color: #96e0b3;
    }

    .roi-label {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .roi-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #155263;
    }

    .roi-note {
        color: #6b7280;
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    .system-comparison {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 1024px) {
        .system-comparison {
            grid-template-columns: 1fr 1fr;
        }
    }

    .system-option-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .system-option-card.panel-only {
        border: 3px solid #60e1e0;
        background: linear-gradient(to bottom, #f0f9ff, #ffffff);
    }

    .system-option-card.panel-battery {
        border: 3px solid #96e0b3;
        background: linear-gradient(to bottom, #f0fff4, #ffffff);
    }

    .system-option-header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(0, 0, 0, 0.1);
    }

    .system-option-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    .system-option-subtitle {
        font-size: 0.875rem;
        color: #6b7280;
        line-height: 1.4;
    }

    .spec-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .spec-row:last-child {
        border-bottom: none;
    }

    .spec-label {
        font-size: 0.875rem;
        color: #6b7280;
        flex: 1;
    }

    .spec-value {
        font-size: 1rem;
        font-weight: 600;
        color: #155263;
        text-align: right;
    }

    .spec-value.highlight {
        font-size: 1.25rem;
        color: #155263;
    }

    .spec-note {
        font-size: 0.75rem;
        color: #6b7280;
        font-style: italic;
        margin-top: 0.25rem;
        text-align: right;
    }

    .system-cost-box {
        background-color: #fffef0;
        border: 1px solid #ffc93c;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .savings-box {
        background: linear-gradient(to right, #f0f9ff, #fffef0);
        border: 2px solid #60e1e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 1rem;
    }

    .assumptions-box {
        background-color: #f9fafb;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 1rem;
    }

    .assumptions-box p {
        color: #052b2f;
        font-size: 0.875rem;
        margin: 0;
    }

    .contact-section {
        border-top: 2px solid #155263;
        padding-top: 2rem;
    }

    .contact-section.hidden {
        display: none;
    }

    .contact-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    .contact-subtitle {
        color: #6b7280;
        margin-bottom: 1.5rem;
    }

    .submit-btn {
        width: 100%;
        background-color: #155263;
        color: white;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .submit-btn:hover {
        background-color: #0d3a45;
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    .success-section {
        border-top: 2px solid #155263;
        padding-top: 2rem;
        text-align: center;
        padding: 3rem 1rem;
        display: none;
    }

    .success-section.show {
        display: block;
    }

    .success-icon {
        width: 4rem;
        height: 4rem;
        margin: 0 auto 1.5rem;
        color: #96e0b3;
    }

    .success-title {
        font-size: 1.875rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 1rem;
    }

    .success-text {
        font-size: 1.125rem;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .success-subtext {
        color: #6b7280;
    }

    .disclaimer {
        text-align: center;
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 1.5rem;
    }

    .slider-container {
        width: 100%;
    }

    .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .slider-value {
        font-weight: 600;
        color: #155263;
        font-size: 1.125rem;
    }

    .form-slider {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #d1d5db;
        outline: none;
        -webkit-appearance: none;
    }

    .form-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #155263;
        cursor: pointer;
        transition: background 0.2s;
    }

    .form-slider::-webkit-slider-thumb:hover {
        background: #0d3a45;
    }

    .form-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #155263;
        cursor: pointer;
        border: none;
        transition: background 0.2s;
    }

    .form-slider::-moz-range-thumb:hover {
        background: #0d3a45;
    }

    .financing-section {
        background: linear-gradient(to right, #f0f9ff, #ffffff);
        border: 2px solid #60e1e0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .financing-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    .financing-subtitle {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 1.5rem;
    }
</style>

<div class="solar-calculator">
    <div class="calc-card">
        <div class="calc-header">
            <h1 class="calc-title">Solar System Financing Calculator</h1>
            <p class="calc-subtitle">Find out what solar system you can afford through green lending</p>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Annual Household Income ($NZ)</label>
                <input type="text" id="householdIncome" class="form-input" placeholder="120,000">
                <span class="error-message" id="error-householdIncome"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Current Property Value ($NZ)</label>
                <input type="text" id="propertyValue" class="form-input" placeholder="800,000">
                <span class="error-message" id="error-propertyValue"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Current Lending/Mortgage ($NZ)</label>
                <input type="text" id="currentLending" class="form-input" placeholder="500,000">
            </div>

            <div class="form-group">
                <label class="form-label">Current Bank</label>
                <input type="text" id="currentBank" class="form-input" placeholder="ANZ, ASB, Westpac, etc.">
            </div>

            <div class="form-group">
                <label class="form-label">Household Expenses ($NZ)</label>
                <input type="text" id="expenseAmount" class="form-input" placeholder="3,000">
            </div>

            <div class="form-group">
                <label class="form-label">Expense Frequency</label>
                <select id="expenseFrequency" class="form-input">
                    <option value="weekly">Weekly</option>
                    <option value="fortnightly">Fortnightly</option>
                    <option value="monthly" selected>Monthly</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Typical Summer Power Bill ($NZ/month)</label>
                <input type="text" id="summerPowerBill" class="form-input" placeholder="300">
                <span class="error-message" id="error-summerPowerBill"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Summer kWh Usage (Look for kWh on page 2 of your power bill)</label>
                <input type="text" id="summerKwh" class="form-input" placeholder="500">
                <span class="error-message" id="error-summerKwh"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Typical Winter Power Bill ($NZ/month)</label>
                <input type="text" id="winterPowerBill" class="form-input" placeholder="400">
                <span class="error-message" id="error-winterPowerBill"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Winter kWh Usage (Look for kWh on page 2 of your power bill)</label>
                <input type="text" id="winterKwh" class="form-input" placeholder="1100">
                <span class="error-message" id="error-winterKwh"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Fixed Daily Charge (Add GST to the figure on your bill)</label>
                <input type="text" id="dailyCharge" class="form-input" placeholder="3.00" step="0.01">
                <span class="error-message" id="error-dailyCharge"></span>
            </div>
        </div>

        <div class="financing-section">
            <h3 class="financing-title">Loan Financing Options</h3>
            <p class="financing-subtitle">Set loan term to 0 (Cash) if you plan to pay in full. Otherwise, specify your loan terms below.</p>

            <div class="form-grid">
                <div class="form-group">
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="form-label">Loan Term</label>
                            <span class="slider-value" id="loanTermValue">Cash</span>
                        </div>
                        <input type="range" id="loanTerm" class="form-slider" min="0" max="10" value="0" step="1">
                    </div>
                </div>

                <div class="form-group">
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="form-label">Annual Interest Rate</label>
                            <span class="slider-value" id="interestRateValue">1.0%</span>
                        </div>
                        <input type="range" id="interestRate" class="form-slider" min="0" max="30" value="1" step="0.1">
                    </div>
                </div>
            </div>
        </div>

        <div class="tip-box">
            <p><strong>Tip:</strong> For the most accurate solar system sizing and savings calculations, please provide your kWh usage from your power bills (typically found on page 2). If you also enter your fixed daily charge, we can calculate your exact cost per kWh and provide detailed system recommendations including panel-only and panel+battery options.</p>
        </div>

        <div id="results" class="results-section"></div>

        <div id="contactForm" class="contact-section">
            <h2 class="contact-title">Speak with a Mortgage Advisor</h2>
            <p class="contact-subtitle">Enter your details to explore green loan options with an expert</p>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">First Name *</label>
                    <input type="text" id="firstName" class="form-input">
                    <span class="error-message" id="error-firstName"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Last Name *</label>
                    <input type="text" id="lastName" class="form-input">
                    <span class="error-message" id="error-lastName"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" id="email" class="form-input">
                    <span class="error-message" id="error-email"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" id="phone" class="form-input" placeholder="021 234 5678">
                    <span class="error-message" id="error-phone"></span>
                </div>

                <!-- Honeypot fields for bot detection -->
                <div style="position: absolute; left: -5000px; opacity: 0; pointer-events: none;" aria-hidden="true">
                    <label>
                        <input type="checkbox" id="agreeToDisagree" name="agreeToDisagree" tabindex="-1" autocomplete="off">
                        Agree to disagree
                    </label>
                    <input type="text" id="city" name="city" tabindex="-1" autocomplete="off" placeholder="City">
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <button type="button" id="submitBtn" class="submit-btn">Contact a Mortgage Advisor</button>
                </div>
            </div>
        </div>

        <div id="successMessage" class="success-section">
            <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <h2 class="success-title">Thank You!</h2>
            <p class="success-text">Your information has been received.</p>
            <p class="success-subtext">Someone will be in touch shortly to talk through your solar financing options.</p>
        </div>

        <p class="disclaimer">* Calculator provides estimates only. Actual lending subject to bank approval.</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
    'use strict';

    var calculationTimer = null;
    var validationTimers = {};
    var resultsData = null;
    var chartInstance = null;
    var financingChartInstance = null;

    var rawValues = {
        householdIncome: '',
        propertyValue: '',
        currentLending: '',
        expenseAmount: '',
        summerPowerBill: '',
        winterPowerBill: '',
        summerKwh: '',
        winterKwh: '',
        dailyCharge: '',
        loanTerm: 0,
        interestRate: 1.0
    };

    function formatNumber(num) {
        if (!num && num !== 0) return '0';
        return parseFloat(num).toLocaleString('en-NZ');
    }

    function formatCurrency(value) {
        if (!value) return '';
        var digits = value.replace(/\D/g, '');
        return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function validateField(fieldId, rawValue) {
        clearTimeout(validationTimers[fieldId]);

        validationTimers[fieldId] = setTimeout(function() {
            var errorEl = document.getElementById('error-' + fieldId);
            var inputEl = document.getElementById(fieldId);
            var numValue = parseFloat(rawValue);

            var error = '';

            switch(fieldId) {
                case 'householdIncome':
                    if (numValue > 5000000) {
                        error = "Whoa there, Scrooge McDuck! Double-check this figure - that's a lot of zeros!";
                    }
                    break;
                case 'summerPowerBill':
                case 'winterPowerBill':
                    if (numValue > 0 && numValue < 50) {
                        error = "Really? Less than $50? Why do you even need solar with that power bill!";
                    } else if (numValue > 2000) {
                        error = "That's a serious power bill! Solar will definitely help, but double-check this number.";
                    }
                    break;
                case 'propertyValue':
                    if (numValue > 0 && numValue < 100000) {
                        error = "Is this a very cozy studio or a typo? NZ property values are usually a bit higher!";
                    } else if (numValue > 20000000) {
                        error = "Mansion alert! That's quite the palace - mind double-checking?";
                    }
                    break;
            }

            if (error) {
                errorEl.textContent = error;
                errorEl.classList.add('show');
                inputEl.classList.add('error');
            } else {
                errorEl.classList.remove('show');
                inputEl.classList.remove('error');
            }
        }, 2000);
    }

    function setupInputs() {
        var currencyFields = ['householdIncome', 'propertyValue', 'currentLending', 'expenseAmount', 'summerPowerBill', 'winterPowerBill', 'summerKwh', 'winterKwh', 'dailyCharge'];

        currencyFields.forEach(function(id) {
            var input = document.getElementById(id);
            if (!input) return;

            input.addEventListener('input', function(e) {
                var digits = e.target.value.replace(/\D/g, '');
                rawValues[id] = digits;
                e.target.value = formatCurrency(digits);
                validateField(id, digits);
                scheduleCalculation();
            });
        });

        var expenseFreq = document.getElementById('expenseFrequency');
        if (expenseFreq) {
            expenseFreq.addEventListener('change', scheduleCalculation);
        }

        // Loan term slider
        var loanTermSlider = document.getElementById('loanTerm');
        var loanTermValue = document.getElementById('loanTermValue');
        if (loanTermSlider && loanTermValue) {
            loanTermSlider.addEventListener('input', function(e) {
                var value = parseInt(e.target.value);
                rawValues.loanTerm = value;
                if (value === 0) {
                    loanTermValue.textContent = 'Cash';
                } else {
                    loanTermValue.textContent = value + (value === 1 ? ' year' : ' years');
                }
                scheduleCalculation();
            });
        }

        // Interest rate slider
        var interestRateSlider = document.getElementById('interestRate');
        var interestRateValue = document.getElementById('interestRateValue');
        if (interestRateSlider && interestRateValue) {
            interestRateSlider.addEventListener('input', function(e) {
                var value = parseFloat(e.target.value);
                rawValues.interestRate = value;
                interestRateValue.textContent = value.toFixed(1) + '%';
                scheduleCalculation();
            });
        }
    }

    function scheduleCalculation() {
        clearTimeout(calculationTimer);

        if (rawValues.householdIncome && rawValues.propertyValue && rawValues.currentLending && rawValues.expenseAmount) {
            calculationTimer = setTimeout(function() {
                calculateResults();
            }, 2000);
        }
    }

    function calculateResults() {
        var income = parseFloat(rawValues.householdIncome) || 0;
        var propertyValue = parseFloat(rawValues.propertyValue) || 0;
        var currentLending = parseFloat(rawValues.currentLending) || 0;
        var expenseAmount = parseFloat(rawValues.expenseAmount) || 0;

        if (!income || !propertyValue || !currentLending || !expenseAmount) {
            return;
        }

        var expenseFreq = document.getElementById('expenseFrequency').value;
        var monthlyExpenses = expenseAmount;
        if (expenseFreq === 'weekly') {
            monthlyExpenses = expenseAmount * 52 / 12;
        } else if (expenseFreq === 'fortnightly') {
            monthlyExpenses = expenseAmount * 26 / 12;
        }

        var monthlyIncome = income / 12;
        var testRate = 0.068;
        var monthlyRate = testRate / 12;
        var numPayments = 30 * 12;

        var currentMonthlyPayment = 0;
        if (currentLending > 0) {
            currentMonthlyPayment = currentLending * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                                    (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        var monthlySurplus = monthlyIncome - monthlyExpenses - currentMonthlyPayment;
        var lvr = propertyValue > 0 ? (currentLending / propertyValue) * 100 : 0;
        var maxLending = propertyValue * 0.80;
        var availableEquity = maxLending - currentLending;
        var hasSufficientSurplus = monthlySurplus > 500;

        var solarReady = false;
        var solarReadyMessage = '';

        if (availableEquity >= 20000 && hasSufficientSurplus) {
            solarReady = true;
            solarReadyMessage = 'Great news! You have sufficient equity and monthly surplus to proceed with solar financing.';
        } else if (availableEquity < 20000) {
            solarReady = false;
            solarReadyMessage = 'Additional equity needed to qualify for solar financing. You need at least $20,000 in available equity.';
        } else if (!hasSufficientSurplus) {
            solarReady = false;
            solarReadyMessage = 'Your equity looks good, but your monthly surplus may restrict financing options. A healthy surplus is needed after refinancing to ensure serviceability.';
        }

        var borrowingPower = 'low';
        var borrowingPowerText = 'Low';
        var borrowingPowerDesc = 'Less than $20,000 available';

        if (availableEquity >= 50000) {
            borrowingPower = 'high';
            borrowingPowerText = 'High';
            borrowingPowerDesc = 'Over $50,000 available';
        } else if (availableEquity >= 20000) {
            borrowingPower = 'medium';
            borrowingPowerText = 'Medium';
            borrowingPowerDesc = '$20,000 - $50,000 available';
        }

        var summerBill = parseFloat(rawValues.summerPowerBill) || 0;
        var winterBill = parseFloat(rawValues.winterPowerBill) || 0;
        var summerKwh = parseFloat(rawValues.summerKwh) || 0;
        var winterKwh = parseFloat(rawValues.winterKwh) || 0;
        var dailyCharge = parseFloat(rawValues.dailyCharge) || 0;

        var annualPowerCost;
        var annualDailyCharges = dailyCharge * 365;
        var annualUsageCost = 0;
        var avgMonthlyKwh = 0;
        var costPerKwh = 0;
        var calculationMethod = 'expenses';

        if (summerBill > 0 && winterBill > 0) {
            var avgMonthlyBill = (summerBill + winterBill) / 2;
            annualPowerCost = avgMonthlyBill * 12;
            calculationMethod = 'bills';

            // Calculate kWh-based metrics if kWh data is provided
            if (summerKwh > 0 && winterKwh > 0) {
                avgMonthlyKwh = (summerKwh + winterKwh) / 2;
                var annualKwh = avgMonthlyKwh * 12;
                annualUsageCost = annualPowerCost - annualDailyCharges;
                costPerKwh = annualUsageCost / annualKwh;
                calculationMethod = 'kwh';
            }
        } else {
            var monthlyPowerCost = monthlyExpenses * 0.05;
            annualPowerCost = monthlyPowerCost * 12;
        }

        // System sizing based on kWh usage (if available)
        var panelOnlySystem = null;
        var panelBatterySystem = null;

        if (avgMonthlyKwh > 0 && costPerKwh > 0) {
            var annualKwhUsage = avgMonthlyKwh * 12;
            var panelWattage = 460; // 460W panels
            var sunHoursPerDay = 3.95; // NZ average sun hours
            var exportRate = 0.18; // 18c per kWh export rate
            var annualPriceIncrease = 0.025; // 2.5% inflation
            var savings25YearMultiplier = 30.82; // Geometric series multiplier for 2.5% over 25 years

            // Panel-only system (110% of annual usage)
            var panelOnlyMonthlyGeneration = avgMonthlyKwh * 1.10;
            var panelOnlyAnnualGeneration = panelOnlyMonthlyGeneration * 12;

            // Calconic formula: ((monthlyGen/30.416)/3.95)/.460
            var panelOnlyPanelCount = Math.ceil(((panelOnlyMonthlyGeneration / 30.416) / sunHoursPerDay) / (panelWattage / 1000));
            var panelOnlySystemKw = (panelOnlyPanelCount * panelWattage) / 1000;

            // Calconic cost formula: panels * 675 + 3500
            var panelOnlySystemCost = (panelOnlyPanelCount * 675) + 3500;

            // Calconic savings: 45% self-consumption at retail, 55% export at 18c
            var panelOnlySelfConsumption = panelOnlyMonthlyGeneration * 0.45 * costPerKwh;
            var panelOnlyExportRevenue = panelOnlyMonthlyGeneration * 0.55 * exportRate;
            var panelOnlyMonthlySavings = panelOnlySelfConsumption + panelOnlyExportRevenue;
            var panelOnlyAnnualSavings = panelOnlyMonthlySavings * 12;
            var panelOnlyPaybackYears = panelOnlySystemCost / panelOnlyAnnualSavings;

            // Calculate 25-year savings using Calconic multiplier
            var panelOnly25YearSavings = (panelOnlyAnnualSavings * savings25YearMultiplier) - panelOnlySystemCost;

            panelOnlySystem = {
                monthlyGeneration: panelOnlyMonthlyGeneration,
                annualGeneration: panelOnlyAnnualGeneration,
                panelCount: panelOnlyPanelCount,
                systemKw: panelOnlySystemKw,
                systemCost: panelOnlySystemCost,
                monthlySavings: panelOnlyMonthlySavings,
                annualSavings: panelOnlyAnnualSavings,
                paybackYears: panelOnlyPaybackYears,
                savings25Year: panelOnly25YearSavings,
                selfConsumptionPercent: 45,
                exportPercent: 55
            };

            // Panel + Battery system (135% of annual usage)
            var panelBatteryMonthlyGeneration = avgMonthlyKwh * 1.35;
            var panelBatteryAnnualGeneration = panelBatteryMonthlyGeneration * 12;

            // Calconic formula: same as panel-only
            var panelBatteryPanelCount = Math.ceil(((panelBatteryMonthlyGeneration / 30.416) / sunHoursPerDay) / (panelWattage / 1000));
            var panelBatterySystemKw = (panelBatteryPanelCount * panelWattage) / 1000;

            // Calconic battery sizing: 0.55 * panel count
            var batteryKwh = Math.ceil(panelBatteryPanelCount * 0.55);

            // Calconic cost formula: (panels * 670) + (battery kWh * 850) + 6250
            var panelBatterySystemCost = (panelBatteryPanelCount * 670) + (batteryKwh * 850) + 6250;

            // Calconic savings: 75% self-consumption at retail, 25% export at 18c
            var panelBatterySelfConsumption = panelBatteryMonthlyGeneration * 0.75 * costPerKwh;
            var panelBatteryExportRevenue = panelBatteryMonthlyGeneration * 0.25 * exportRate;
            var panelBatteryMonthlySavings = panelBatterySelfConsumption + panelBatteryExportRevenue;
            var panelBatteryAnnualSavings = panelBatteryMonthlySavings * 12;
            var panelBatteryPaybackYears = panelBatterySystemCost / panelBatteryAnnualSavings;

            // Calculate 25-year savings using Calconic multiplier
            var panelBattery25YearSavings = (panelBatteryAnnualSavings * savings25YearMultiplier) - panelBatterySystemCost;

            panelBatterySystem = {
                monthlyGeneration: panelBatteryMonthlyGeneration,
                annualGeneration: panelBatteryAnnualGeneration,
                panelCount: panelBatteryPanelCount,
                systemKw: panelBatterySystemKw,
                batteryKwh: batteryKwh,
                systemCost: panelBatterySystemCost,
                monthlySavings: panelBatteryMonthlySavings,
                annualSavings: panelBatteryAnnualSavings,
                paybackYears: panelBatteryPaybackYears,
                savings25Year: panelBattery25YearSavings,
                selfConsumptionPercent: 75,
                exportPercent: 25
            };
        }

        // Keep original calculation for backwards compatibility
        var solarCoveragePercent = 0.80;
        var annualSolarSavings = annualPowerCost * solarCoveragePercent;
        var solarSystemCost = annualSolarSavings * 9;
        var annualPriceIncrease = avgMonthlyKwh > 0 ? 0.025 : 0.04;

        // Loan financing calculations
        var loanTerm = rawValues.loanTerm;
        var interestRate = rawValues.interestRate;
        var isFinanced = loanTerm > 0;
        var monthlyLoanPayment = 0;
        var totalLoanPayments = 0;
        var totalInterestPaid = 0;
        var paybackPeriod = 8;

        if (isFinanced) {
            var monthlyInterestRate = (interestRate / 100) / 12;
            var numLoanPayments = loanTerm * 12;

            if (monthlyInterestRate > 0) {
                // Calculate monthly payment using amortization formula
                monthlyLoanPayment = solarSystemCost * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numLoanPayments)) /
                                    (Math.pow(1 + monthlyInterestRate, numLoanPayments) - 1);
            } else {
                // If 0% interest, just divide by months
                monthlyLoanPayment = solarSystemCost / numLoanPayments;
            }

            totalLoanPayments = monthlyLoanPayment * numLoanPayments;
            totalInterestPaid = totalLoanPayments - solarSystemCost;

            // Recalculate payback period considering financing costs
            var effectiveCost = totalLoanPayments;
            paybackPeriod = Math.ceil(effectiveCost / annualSolarSavings);

            // Recalculate monthly surplus including solar loan payment
            monthlySurplus = monthlySurplus - monthlyLoanPayment;
            hasSufficientSurplus = monthlySurplus > 500;
        }

        var chartData = [];
        var financingChartData = [];
        var cumulativeSolarSavings = 0;
        var cumulativePowerCostWithoutSolar = annualPowerCost;
        var cumulativePowerCostWithSolar = annualPowerCost * (1 - solarCoveragePercent);
        var cumulativeFinancingCost = 0;

        for (var year = 0; year <= 25; year++) {
            var yearlyPowerCost = annualPowerCost * Math.pow(1 + annualPriceIncrease, year);
            var yearlySolarSavings = yearlyPowerCost * solarCoveragePercent;

            // Calculate financing costs for this year
            var yearlyFinancingCost = 0;
            if (isFinanced && year <= loanTerm) {
                yearlyFinancingCost = monthlyLoanPayment * 12;
            }

            if (year > 0) {
                cumulativeSolarSavings += yearlySolarSavings;
                cumulativePowerCostWithoutSolar += yearlyPowerCost;
                cumulativePowerCostWithSolar += yearlyPowerCost * (1 - solarCoveragePercent);
                cumulativeFinancingCost += yearlyFinancingCost;
            }

            chartData.push({
                year: year,
                withoutSolar: Math.round(cumulativePowerCostWithoutSolar),
                withSolar: Math.round(cumulativePowerCostWithSolar + (isFinanced ? cumulativeFinancingCost : solarSystemCost))
            });

            // Financing chart data: annual solar savings vs financing costs
            financingChartData.push({
                year: year,
                solarSavings: year === 0 ? 0 : Math.round(cumulativeSolarSavings),
                financingCost: Math.round(cumulativeFinancingCost)
            });
        }

        // Calculate net savings accounting for financing
        var net25YearSavings = isFinanced ?
            (cumulativeSolarSavings - totalLoanPayments) :
            (cumulativeSolarSavings - solarSystemCost);

        resultsData = {
            lvr: lvr.toFixed(2),
            solarReady: solarReady,
            solarReadyMessage: solarReadyMessage,
            hasSufficientSurplus: hasSufficientSurplus,
            borrowingPower: borrowingPower,
            borrowingPowerText: borrowingPowerText,
            borrowingPowerDesc: borrowingPowerDesc,
            monthlyIncome: monthlyIncome.toFixed(2),
            monthlyExpenses: monthlyExpenses.toFixed(2),
            currentMonthlyPayment: currentMonthlyPayment.toFixed(2),
            monthlySurplus: monthlySurplus.toFixed(2),
            estimatedPowerCost: annualPowerCost.toFixed(2),
            annualSolarSavings: annualSolarSavings.toFixed(2),
            total25YearSavings: net25YearSavings.toFixed(2),
            solarSystemCost: solarSystemCost.toFixed(2),
            calculationMethod: calculationMethod,
            chartData: chartData,
            financingChartData: financingChartData,
            isFinanced: isFinanced,
            loanTerm: loanTerm,
            interestRate: interestRate.toFixed(1),
            monthlyLoanPayment: monthlyLoanPayment.toFixed(2),
            totalLoanPayments: totalLoanPayments.toFixed(2),
            totalInterestPaid: totalInterestPaid.toFixed(2),
            paybackPeriod: paybackPeriod,
            // New kWh-based metrics
            annualDailyCharges: annualDailyCharges.toFixed(2),
            annualUsageCost: annualUsageCost.toFixed(2),
            avgMonthlyKwh: avgMonthlyKwh.toFixed(0),
            costPerKwh: costPerKwh.toFixed(4),
            panelOnlySystem: panelOnlySystem,
            panelBatterySystem: panelBatterySystem
        };

        displayResults(resultsData);
    }

    function displayResults(data) {
        var resultsDiv = document.getElementById('results');
        if (!resultsDiv) return;

        resultsDiv.classList.add('show');

        var html = '';

        // Solar Ready Status Card
        html += '<div class="result-card">';
        html += '  <div class="result-header">';
        html += '    <div style="flex: 1;">';
        html += '      <h2 class="result-title">Solar Ready Status</h2>';
        html += '      <p class="result-text">' + data.solarReadyMessage + '</p>';
        if (!data.hasSufficientSurplus) {
            html += '      <p class="result-note">Note: Low or medium borrowing power may restrict your financing options. Banks require sufficient monthly surplus to remain after any top-up or refinance is completed.</p>';
        }
        if (data.isFinanced && data.hasSufficientSurplus) {
            html += '      <p class="result-note">Monthly surplus includes the solar loan payment of $' + formatNumber(data.monthlyLoanPayment) + '/month.</p>';
        }
        html += '    </div>';
        if (data.solarReady) {
            html += '    <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        }
        html += '  </div>';
        html += '</div>';

        // Power Grid
        html += '<div class="power-grid">';
        html += '  <div class="power-card ' + data.borrowingPower + '">';
        html += '    <h3 class="power-header">Borrowing Power</h3>';
        html += '    <div class="power-content">';
        html += '      <div>';
        html += '        <p class="power-text ' + data.borrowingPower + '">' + data.borrowingPowerText + '</p>';
        html += '        <p class="power-subtext">' + data.borrowingPowerDesc + '</p>';
        html += '      </div>';
        html += '      <div class="power-dot ' + data.borrowingPower + '"></div>';
        html += '    </div>';
        html += '  </div>';
        html += '  <div class="lvr-card">';
        html += '    <h3 class="power-header">Current LVR</h3>';
        html += '    <p class="power-text" style="color: #155263;">' + data.lvr + '%</p>';
        html += '    <p class="power-subtext">Based on 80% lending threshold</p>';
        html += '  </div>';
        html += '</div>';

        // Serviceability Card
        html += '<div class="serviceability-card">';
        html += '  <h3 class="power-header">Monthly Serviceability (at 6.8% test rate)</h3>';
        html += '  <div class="service-grid">';
        html += '    <div>';
        html += '      <div class="service-row">';
        html += '        <span class="service-label">Monthly Income:</span>';
        html += '        <span class="service-value">$' + formatNumber(data.monthlyIncome) + '</span>';
        html += '      </div>';
        html += '      <div class="service-row">';
        html += '        <span class="service-label">Monthly Expenses:</span>';
        html += '        <span class="service-value">$' + formatNumber(data.monthlyExpenses) + '</span>';
        html += '      </div>';
        html += '      <div class="service-row">';
        html += '        <span class="service-label">Current Mortgage Payment:</span>';
        html += '        <span class="service-value">$' + formatNumber(data.currentMonthlyPayment) + '</span>';
        html += '      </div>';
        if (data.isFinanced) {
            html += '      <div class="service-row">';
            html += '        <span class="service-label">Solar Loan Payment:</span>';
            html += '        <span class="service-value">$' + formatNumber(data.monthlyLoanPayment) + '</span>';
            html += '      </div>';
        }
        html += '    </div>';
        html += '    <div class="surplus-box">';
        html += '      <div>';
        html += '        <p class="power-subtext">Monthly Surplus</p>';
        var surplusColor = parseFloat(data.monthlySurplus) > 0 ? '#96e0b3' : '#60e1e0';
        html += '        <p class="surplus-amount" style="color: ' + surplusColor + '">$' + formatNumber(data.monthlySurplus) + '</p>';
        html += '      </div>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';

        // ROI Card
        html += '<div class="roi-card">';
        html += '  <h3 class="result-title">Solar Investment Returns (25 Year Projection)</h3>';
        html += '  <div class="roi-grid">';
        html += '    <div class="roi-box blue">';
        html += '      <p class="roi-label">' + (data.calculationMethod === 'bills' ? 'Current Annual Power Cost' : 'Estimated Annual Power Cost') + '</p>';
        html += '      <p class="roi-value">$' + formatNumber(data.estimatedPowerCost) + '</p>';
        if (data.calculationMethod === 'expenses') {
            html += '      <p class="roi-note">Based on household expenses</p>';
        }
        html += '    </div>';
        html += '    <div class="roi-box yellow">';
        html += '      <p class="roi-label">Annual Solar Savings (80% coverage)</p>';
        html += '      <p class="roi-value">$' + formatNumber(data.annualSolarSavings) + '</p>';
        html += '    </div>';
        html += '    <div class="roi-box green">';
        html += '      <p class="roi-label">Payback Period</p>';
        html += '      <p class="roi-value">' + data.paybackPeriod + ' years</p>';
        if (data.isFinanced) {
            html += '      <p class="roi-note">Including financing costs</p>';
        }
        html += '    </div>';
        html += '  </div>';

        // Detailed kWh-based outputs (if kWh data is available)
        if (data.calculationMethod === 'kwh' && parseFloat(data.avgMonthlyKwh) > 0) {
            html += '<div class="roi-card" style="background: linear-gradient(to right, #fffef0, #ffffff); border: 2px solid #ffc93c;">';
            html += '  <h3 class="result-title">Your Power Usage Analysis</h3>';
            html += '  <div class="roi-grid">';
            html += '    <div class="roi-box yellow">';
            html += '      <p class="roi-label">Annual Power Cost</p>';
            html += '      <p class="roi-value">$' + formatNumber(data.estimatedPowerCost) + '</p>';
            html += '    </div>';
            html += '    <div class="roi-box blue">';
            html += '      <p class="roi-label">Annual Daily Charges</p>';
            html += '      <p class="roi-value">$' + formatNumber(data.annualDailyCharges) + '</p>';
            html += '      <p class="roi-note">Fixed connection fees</p>';
            html += '    </div>';
            html += '    <div class="roi-box green">';
            html += '      <p class="roi-label">Annual Usage Cost</p>';
            html += '      <p class="roi-value">$' + formatNumber(data.annualUsageCost) + '</p>';
            html += '      <p class="roi-note">What you pay for power itself</p>';
            html += '    </div>';
            html += '  </div>';
            html += '  <div class="roi-grid" style="margin-top: 1rem;">';
            html += '    <div class="roi-box blue">';
            html += '      <p class="roi-label">Average Monthly kWh Usage</p>';
            html += '      <p class="roi-value">' + data.avgMonthlyKwh + ' kWh</p>';
            html += '    </div>';
            html += '    <div class="roi-box yellow">';
            html += '      <p class="roi-label">Cost Per kWh (GST Inclusive)</p>';
            html += '      <p class="roi-value">$' + data.costPerKwh + '</p>';
            html += '    </div>';
            html += '    <div class="roi-box green">';
            html += '      <p class="roi-label">25-Year Power Cost Projection</p>';
            var projected25YearCost = parseFloat(data.estimatedPowerCost) * 35.45; // 3% inflation over 25 years
            html += '      <p class="roi-value">$' + formatNumber(projected25YearCost.toFixed(0)) + '</p>';
            html += '      <p class="roi-note">If you don\'t get solar (3% annual inflation)</p>';
            html += '    </div>';
            html += '  </div>';
            html += '</div>';

            // System comparison section
            if (data.panelOnlySystem || data.panelBatterySystem) {
                html += '<h3 class="result-title" style="margin-top: 2rem; margin-bottom: 1rem; text-align: center;">Recommended Solar System Options</h3>';
                html += '<div class="system-comparison">';

                // Panel-only system
                if (data.panelOnlySystem) {
                    var sys = data.panelOnlySystem;
                    html += '<div class="system-option-card panel-only">';
                    html += '  <div class="system-option-header">';
                    html += '    <h4 class="system-option-title">Panel-Only System (110%)</h4>';
                    html += '    <p class="system-option-subtitle">Replaces ~35% of winter bills, up to 80% of summer bills</p>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Monthly Generation Target</span>';
                    html += '    <div><span class="spec-value highlight">' + Math.round(sys.monthlyGeneration) + ' kWh</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">System Size</span>';
                    html += '    <div><span class="spec-value">' + sys.panelCount + ' panels (' + sys.systemKw.toFixed(1) + ' kW)</span><div class="spec-note">Using 460W panels</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Estimated System Cost</span>';
                    html += '    <div><span class="spec-value highlight">$' + formatNumber(sys.systemCost.toFixed(0)) + '</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Monthly Savings</span>';
                    html += '    <div><span class="spec-value">$' + formatNumber(sys.monthlySavings.toFixed(0)) + '</span><div class="spec-note">' + sys.selfConsumptionPercent + '% self-use, ' + sys.exportPercent + '% export @ 18c</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Annual Savings</span>';
                    html += '    <div><span class="spec-value">$' + formatNumber(sys.annualSavings.toFixed(0)) + '</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Payback Period</span>';
                    html += '    <div><span class="spec-value">' + sys.paybackYears.toFixed(2) + ' years</span><div class="spec-note">If power prices stay the same</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">25-Year Net Savings</span>';
                    html += '    <div><span class="spec-value highlight" style="color: #15803d;">$' + formatNumber(sys.savings25Year.toFixed(0)) + '</span><div class="spec-note">Assuming 2.5% inflation</div></div>';
                    html += '  </div>';

                    html += '</div>';
                }

                // Panel + Battery system
                if (data.panelBatterySystem) {
                    var sysBatt = data.panelBatterySystem;
                    html += '<div class="system-option-card panel-battery">';
                    html += '  <div class="system-option-header">';
                    html += '    <h4 class="system-option-title">Panel + Battery System (135%)</h4>';
                    html += '    <p class="system-option-subtitle">Replaces ~50% of winter bills, up to 100% of summer bills</p>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Monthly Generation Target</span>';
                    html += '    <div><span class="spec-value highlight">' + Math.round(sysBatt.monthlyGeneration) + ' kWh</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">System Size</span>';
                    html += '    <div><span class="spec-value">' + sysBatt.panelCount + ' panels (' + sysBatt.systemKw.toFixed(1) + ' kW)</span><div class="spec-note">Using 460W panels</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Battery Storage</span>';
                    html += '    <div><span class="spec-value">' + sysBatt.batteryKwh + ' kWh</span><div class="spec-note">Recommended capacity</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Estimated System Cost</span>';
                    html += '    <div><span class="spec-value highlight">$' + formatNumber(sysBatt.systemCost.toFixed(0)) + '</span><div class="spec-note">Including battery</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Monthly Savings</span>';
                    html += '    <div><span class="spec-value">$' + formatNumber(sysBatt.monthlySavings.toFixed(0)) + '</span><div class="spec-note">' + sysBatt.selfConsumptionPercent + '% self-use, ' + sysBatt.exportPercent + '% export @ 18c</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Annual Savings</span>';
                    html += '    <div><span class="spec-value">$' + formatNumber(sysBatt.annualSavings.toFixed(0)) + '</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Payback Period</span>';
                    html += '    <div><span class="spec-value">' + sysBatt.paybackYears.toFixed(2) + ' years</span><div class="spec-note">If power prices stay the same</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">25-Year Net Savings</span>';
                    html += '    <div><span class="spec-value highlight" style="color: #15803d;">$' + formatNumber(sysBatt.savings25Year.toFixed(0)) + '</span><div class="spec-note">Battery replacement not factored</div></div>';
                    html += '  </div>';

                    html += '</div>';
                }

                html += '</div>';
            }
        }

        // Financing Details (if loan is used)
        if (data.isFinanced) {
            html += '  <div class="system-cost-box" style="background-color: #f0f9ff; border-color: #60e1e0;">';
            html += '    <p class="roi-label">Loan Financing Details</p>';
            html += '    <div class="roi-grid" style="margin-bottom: 0;">';
            html += '      <div>';
            html += '        <p class="roi-note" style="margin-bottom: 0.25rem;">Monthly Payment</p>';
            html += '        <p class="roi-value" style="font-size: 1.25rem;">$' + formatNumber(data.monthlyLoanPayment) + '</p>';
            html += '      </div>';
            html += '      <div>';
            html += '        <p class="roi-note" style="margin-bottom: 0.25rem;">Loan Term</p>';
            html += '        <p class="roi-value" style="font-size: 1.25rem;">' + data.loanTerm + ' years @ ' + data.interestRate + '%</p>';
            html += '      </div>';
            html += '      <div>';
            html += '        <p class="roi-note" style="margin-bottom: 0.25rem;">Total Interest Paid</p>';
            html += '        <p class="roi-value" style="font-size: 1.25rem;">$' + formatNumber(data.totalInterestPaid) + '</p>';
            html += '      </div>';
            html += '    </div>';
            html += '  </div>';
        }
        html += '  </div>';

        html += '  <div class="system-cost-box">';
        html += '    <p class="roi-label">Estimated Solar System Cost</p>';
        html += '    <p class="roi-value">$' + formatNumber(data.solarSystemCost) + '</p>';
        if (data.isFinanced) {
            html += '    <p class="roi-note">Total financed cost: $' + formatNumber(data.totalLoanPayments) + ' (' + data.loanTerm + ' year loan @ ' + data.interestRate + '%)</p>';
        } else {
            html += '    <p class="roi-note">Cash purchase - no financing costs</p>';
        }
        html += '  </div>';

        html += '  <div class="savings-box">';
        html += '    <p class="roi-label">Total 25-Year Net Savings</p>';
        html += '    <p class="roi-value">$' + formatNumber(data.total25YearSavings) + '</p>';
        if (data.isFinanced) {
            html += '    <p class="roi-note">After deducting all financing costs ($' + formatNumber(data.totalLoanPayments) + ')</p>';
        } else {
            html += '    <p class="roi-note">Based on 4% annual power price increase projection</p>';
        }
        html += '  </div>';

        html += '  <h3 class="result-title" style="margin-top: 2rem;">Power Costs Over Time</h3>';
        html += '  <div class="chart-container">';
        html += '    <canvas id="solarChart"></canvas>';
        html += '  </div>';

        // Add financing chart if loan is used
        if (data.isFinanced) {
            html += '  <h3 class="result-title" style="margin-top: 2rem;">Financing Cost vs Solar Savings</h3>';
            html += '  <div class="chart-container">';
            html += '    <canvas id="financingChart"></canvas>';
            html += '  </div>';
        }

        html += '  <div class="assumptions-box">';
        html += '    <p><strong>Key Assumptions:</strong> Solar system sized for ' + (data.isFinanced ? data.paybackPeriod : '8') + '-year payback | Coverage: 80% of power usage | Projected power price increase: 4% annually | System lifespan: 25 years';
        if (data.isFinanced) {
            html += ' | Financing: ' + data.loanTerm + ' year loan @ ' + data.interestRate + '% interest';
        } else {
            html += ' | Cash purchase (no financing)';
        }
        if (data.calculationMethod === 'bills') {
            html += ' | Calculation based on your actual power bills';
        } else {
            html += ' | Power costs estimated from household expenses';
        }
        html += '    </p>';
        html += '  </div>';
        html += '</div>';

        resultsDiv.innerHTML = html;

        // Destroy existing charts
        if (chartInstance) {
            chartInstance.destroy();
        }
        if (financingChartInstance) {
            financingChartInstance.destroy();
        }

        // Create main savings chart
        var ctx = document.getElementById('solarChart');
        if (ctx && typeof Chart !== 'undefined') {
            var chartLabel = data.isFinanced ? 'With Solar (inc. financing)' : 'With Solar (inc. system cost)';
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chartData.map(function(d) { return d.year; }),
                    datasets: [
                        {
                            label: 'Without Solar',
                            data: data.chartData.map(function(d) { return d.withoutSolar; }),
                            borderColor: '#60e1e0',
                            backgroundColor: 'rgba(96, 225, 224, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: chartLabel,
                            data: data.chartData.map(function(d) { return d.withSolar; }),
                            borderColor: '#ffc93c',
                            backgroundColor: 'rgba(255, 201, 60, 0.2)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatNumber(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            }
                        }
                    }
                }
            });
        }

        // Create financing chart if applicable
        if (data.isFinanced) {
            var financingCtx = document.getElementById('financingChart');
            if (financingCtx && typeof Chart !== 'undefined') {
                financingChartInstance = new Chart(financingCtx, {
                    type: 'line',
                    data: {
                        labels: data.financingChartData.map(function(d) { return d.year; }),
                        datasets: [
                            {
                                label: 'Cumulative Solar Savings',
                                data: data.financingChartData.map(function(d) { return d.solarSavings; }),
                                borderColor: '#96e0b3',
                                backgroundColor: 'rgba(150, 224, 179, 0.2)',
                                fill: true,
                                tension: 0.1
                            },
                            {
                                label: 'Cumulative Financing Cost',
                                data: data.financingChartData.map(function(d) { return d.financingCost; }),
                                borderColor: '#ff6b6b',
                                backgroundColor: 'rgba(255, 107, 107, 0.2)',
                                fill: true,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + formatNumber(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + formatNumber(value);
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Years'
                                }
                            }
                        }
                    }
                });
            }
        }
    }

    // Submit button handler
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();

        // Honeypot check - if these fields are filled/checked, it's a bot
        var agreeToDisagree = document.getElementById('agreeToDisagree').checked;
        var cityField = document.getElementById('city').value.trim();

        if (agreeToDisagree || cityField) {
            // Silently fail for bots
            return;
        }

        var firstName = document.getElementById('firstName').value.trim();
        var lastName = document.getElementById('lastName').value.trim();
        var email = document.getElementById('email').value.trim();
        var phone = document.getElementById('phone').value.trim();

        // Clear all errors first
        document.querySelectorAll('.error-message').forEach(function(el) {
            el.classList.remove('show');
            el.textContent = '';
        });
        document.querySelectorAll('.form-input').forEach(function(input) {
            input.classList.remove('error');
        });

        var errors = {};

        if (!firstName) errors.firstName = "We'd love to know your name!";
        if (!lastName) errors.lastName = "Last name too, please!";

        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            errors.email = "We'll need your email to get in touch!";
        } else if (!emailRegex.test(email)) {
            errors.email = "Hmm, that email looks a bit odd. Check for typos?";
        }

        var nzPhoneRegex = /^(\+64|0)[2-9]\d{7,9}$/;
        var cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
        if (!phone) {
            errors.phone = "How can we call you?";
        } else if (!nzPhoneRegex.test(cleanPhone)) {
            errors.phone = "We need a valid NZ phone number (e.g., 021 234 5678)";
        }

        if (Object.keys(errors).length > 0) {
            for (var field in errors) {
                var errorEl = document.getElementById('error-' + field);
                var inputEl = document.getElementById(field);
                if (errorEl) {
                    errorEl.textContent = errors[field];
                    errorEl.classList.add('show');
                }
                if (inputEl) {
                    inputEl.classList.add('error');
                }
            }
            var firstErrorField = Object.keys(errors)[0];
            document.getElementById(firstErrorField).scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        var webhookData = {
            firstName: firstName,
            lastName: lastName,
            email: email,
            phone: phone,
            householdIncome: rawValues.householdIncome,
            propertyValue: rawValues.propertyValue,
            currentLending: rawValues.currentLending,
            currentBank: document.getElementById('currentBank').value,
            expenseAmount: rawValues.expenseAmount,
            expenseFrequency: document.getElementById('expenseFrequency').value,
            summerPowerBill: rawValues.summerPowerBill,
            winterPowerBill: rawValues.winterPowerBill,
            submittedAt: new Date().toISOString()
        };

        if (resultsData) {
            webhookData.lvr = resultsData.lvr;
            webhookData.borrowingPower = resultsData.borrowingPowerText;
            webhookData.solarReady = resultsData.solarReady;
            webhookData.estimatedSolarSystemCost = resultsData.solarSystemCost;
            webhookData.annualSolarSavings = resultsData.annualSolarSavings;
            webhookData.total25YearSavings = resultsData.total25YearSavings;
            webhookData.monthlySurplus = resultsData.monthlySurplus;
            webhookData.isFinanced = resultsData.isFinanced;
            if (resultsData.isFinanced) {
                webhookData.loanTerm = resultsData.loanTerm;
                webhookData.interestRate = resultsData.interestRate;
                webhookData.monthlyLoanPayment = resultsData.monthlyLoanPayment;
                webhookData.totalLoanPayments = resultsData.totalLoanPayments;
                webhookData.totalInterestPaid = resultsData.totalInterestPaid;
                webhookData.paybackPeriod = resultsData.paybackPeriod;
            }
        }

        // Convert to form data to avoid CORS preflight issues
        var formData = new FormData();
        for (var key in webhookData) {
            if (webhookData.hasOwnProperty(key)) {
                formData.append(key, webhookData[key]);
            }
        }

        fetch('https://hooks.zapier.com/hooks/catch/25081790/urfarah/', {
            method: 'POST',
            body: formData
        }).then(function() {
            document.getElementById('contactForm').classList.add('hidden');
            document.getElementById('successMessage').classList.add('show');
        }).catch(function(error) {
            console.error('Error:', error);
            document.getElementById('contactForm').classList.add('hidden');
            document.getElementById('successMessage').classList.add('show');
        });
    });

    // Initialize
    setupInputs();
})();
</script>

</body>
</html>
