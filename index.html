<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Calculator Embed</title>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M9NQGKJ2');</script>
    <!-- End Google Tag Manager -->
</head>
<body>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M9NQGKJ2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        background: linear-gradient(135deg, #e0f7fa 0%, #f0f9ff 50%, #fff9e6 100%);
        min-height: 100vh;
    }

    .solar-calculator {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem 0.5rem;
    }

    @media (min-width: 768px) {
        .solar-calculator {
            padding: 2rem 1rem;
        }
    }

    .calc-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(21, 82, 99, 0.15);
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-top: 4px solid #155263;
    }

    @media (min-width: 768px) {
        .calc-card {
            padding: 2rem;
        }
    }

    .calc-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    @media (min-width: 768px) {
        .calc-header {
            margin-bottom: 2rem;
        }
    }

    .calc-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    @media (min-width: 768px) {
        .calc-title {
            font-size: 2rem;
        }
    }

    .calc-subtitle {
        color: #6b7280;
        font-size: 0.875rem;
    }

    @media (min-width: 768px) {
        .calc-subtitle {
            font-size: 1rem;
        }
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid #9ca3af;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.7);
        border-color: #155263;
        box-shadow: 0 4px 20px rgba(21, 82, 99, 0.15);
    }

    .form-input.error {
        border-color: #ef4444;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: none;
    }

    .error-message.show {
        display: block;
    }

    .tip-box {
        background: rgba(240, 249, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(96, 225, 224, 0.3);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 16px rgba(96, 225, 224, 0.1);
    }

    .tip-box p {
        color: #052b2f;
        font-size: 0.875rem;
        margin: 0;
    }

    .results-section {
        display: none;
        margin-bottom: 2rem;
    }

    .results-section.show {
        display: block;
    }

    .result-card {
        background: rgba(240, 249, 255, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(96, 225, 224, 0.3);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 24px rgba(96, 225, 224, 0.12);
    }

    @media (min-width: 768px) {
        .result-card {
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .result-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    @media (min-width: 768px) {
        .result-title {
            font-size: 1.5rem;
        }
    }

    .result-text {
        color: #6b7280;
        margin-bottom: 0.75rem;
    }

    .result-note {
        color: #6b7280;
        font-size: 0.875rem;
        font-style: italic;
    }

    .status-icon {
        width: 3rem;
        height: 3rem;
        color: #60e1e0;
        flex-shrink: 0;
    }

    .power-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
        .power-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .power-card {
        padding: 1rem;
        border-radius: 16px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    @media (min-width: 768px) {
        .power-card {
            padding: 1.5rem;
        }
    }

    .power-card.low {
        background: rgba(239, 246, 255, 0.6);
        border-color: rgba(147, 197, 253, 0.4);
    }

    .power-card.medium {
        background: rgba(255, 254, 240, 0.6);
        border-color: rgba(255, 201, 60, 0.4);
    }

    .power-card.high {
        background: rgba(255, 254, 240, 0.6);
        border-color: rgba(255, 201, 60, 0.4);
    }

    .power-header {
        font-size: 1.125rem;
        font-weight: 600;
        color: #155263;
        margin-bottom: 1rem;
    }

    .power-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .power-text {
        font-size: 1.875rem;
        font-weight: bold;
    }

    .power-text.low {
        color: #1e40af;
    }

    .power-text.medium {
        color: #92400e;
    }

    .power-text.high {
        color: #92400e;
    }

    .power-subtext {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .power-dot {
        width: 5rem;
        height: 5rem;
        flex-shrink: 0;
        position: relative;
    }

    .power-dot svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }

    .sun-ray {
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 0.6;
        }
        50% {
            opacity: 1;
        }
    }

    .lvr-card {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(21, 82, 99, 0.1);
        border: 1px solid rgba(21, 82, 99, 0.2);
    }

    .serviceability-card {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(21, 82, 99, 0.1);
        border: 1px solid rgba(21, 82, 99, 0.2);
        margin-bottom: 2rem;
    }

    .service-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    @media (min-width: 768px) {
        .service-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .service-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        padding: 0.5rem 0;
    }

    .service-label {
        color: #6b7280;
    }

    .service-value {
        font-weight: 500;
    }

    .surplus-box {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .surplus-amount {
        font-size: 1.875rem;
        font-weight: bold;
    }

    .roi-card {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(21, 82, 99, 0.1);
        border: 1px solid rgba(21, 82, 99, 0.2);
        margin-bottom: 2rem;
    }

    .roi-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (min-width: 768px) {
        .roi-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .roi-box {
        padding: 1rem;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    .roi-box.blue {
        background: rgba(240, 249, 255, 0.6);
        border-color: rgba(96, 225, 224, 0.3);
    }

    .roi-box.yellow {
        background: rgba(255, 254, 240, 0.6);
        border-color: rgba(255, 201, 60, 0.3);
    }

    .roi-box.green {
        background: rgba(255, 254, 240, 0.6);
        border-color: rgba(255, 201, 60, 0.3);
    }

    .roi-label {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .roi-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #155263;
    }

    .roi-note {
        color: #6b7280;
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    .system-comparison {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 1024px) {
        .system-comparison {
            grid-template-columns: 1fr 1fr;
        }
    }

    .system-option-card {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .system-option-card.panel-only {
        background: white;
        border-color: rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .system-option-card.panel-only.selected {
        background: #155263;
        border-color: #155263;
    }

    .system-option-card.panel-only.selected * {
        color: white !important;
    }

    .system-option-card.panel-battery {
        background: white;
        border-color: rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .system-option-card.panel-battery.selected {
        background: #ffc93c;
        border-color: #ffc93c;
    }

    .system-option-card.panel-battery.selected * {
        color: white !important;
    }

    .system-option-header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(0, 0, 0, 0.1);
    }

    .system-option-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #60e1e0;
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
        cursor: help;
        position: relative;
    }

    .tooltip-icon:hover .tooltip-content {
        visibility: visible;
        opacity: 1;
    }

    .tooltip-content {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        z-index: 1000;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(21, 82, 99, 0.98);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: white;
        text-align: left;
        padding: 1rem;
        border-radius: 12px;
        width: 320px;
        font-size: 0.875rem;
        font-weight: normal;
        line-height: 1.5;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s, visibility 0.3s;
    }

    .tooltip-content::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -8px;
        border-width: 8px;
        border-style: solid;
        border-color: rgba(21, 82, 99, 0.98) transparent transparent transparent;
    }

    .tooltip-content ul {
        margin: 0.5rem 0 0 0;
        padding-left: 1.25rem;
    }

    .tooltip-content li {
        margin-bottom: 0.5rem;
    }

    .tooltip-content li:last-child {
        margin-bottom: 0;
    }

    .tooltip-content strong {
        color: #60e1e0;
    }

    .system-option-subtitle {
        font-size: 0.875rem;
        color: #6b7280;
        line-height: 1.4;
    }

    .spec-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .spec-row:last-child {
        border-bottom: none;
    }

    .spec-row > div {
        text-align: right;
    }

    .spec-label {
        font-size: 0.875rem;
        color: #6b7280;
        flex: 1;
        text-align: left;
    }

    .spec-value {
        font-size: 1rem;
        font-weight: 600;
        color: #155263;
        text-align: right;
    }

    .spec-value.highlight {
        font-size: 1.25rem;
        color: #155263;
    }

    .spec-note {
        font-size: 0.75rem;
        color: #6b7280;
        font-style: italic;
        margin-top: 0.25rem;
        text-align: right;
    }

    .system-cost-box {
        background: rgba(255, 254, 240, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 201, 60, 0.3);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(255, 201, 60, 0.1);
    }

    .savings-box {
        background: rgba(240, 249, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(96, 225, 224, 0.3);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(96, 225, 224, 0.1);
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 1rem;
    }

    .assumptions-box {
        background: rgba(249, 250, 251, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(209, 213, 219, 0.3);
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .assumptions-box p {
        color: #052b2f;
        font-size: 0.875rem;
        margin: 0;
    }

    .contact-section {
        border-top: 2px solid #155263;
        padding-top: 2rem;
    }

    .contact-section.hidden {
        display: none;
    }

    .contact-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    .contact-subtitle {
        color: #374151;
        margin-bottom: 1.5rem;
    }

    .green-loan-highlight {
        background: rgba(255, 254, 240, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 201, 60, 0.3);
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 4px 16px rgba(255, 201, 60, 0.15);
    }

    .highlight-icon {
        font-size: 2.5rem;
        flex-shrink: 0;
    }

    .highlight-text {
        flex: 1;
    }

    .highlight-text strong {
        color: #155263;
        font-size: 1.125rem;
    }

    .submit-btn {
        width: 100%;
        background: rgba(21, 82, 99, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: white;
        font-weight: 700;
        padding: 1rem 2rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        font-size: 1.125rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 24px rgba(21, 82, 99, 0.3);
        position: relative;
        overflow: hidden;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    .submit-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .submit-btn:hover::before {
        left: 100%;
    }

    .submit-btn:hover {
        background: rgba(26, 101, 119, 0.95);
        box-shadow: 0 12px 32px rgba(21, 82, 99, 0.4);
        transform: translateY(-2px);
    }

    .submit-btn:active {
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(21, 82, 99, 0.3);
    }

    .success-section {
        border-top: 2px solid #155263;
        padding-top: 2rem;
        text-align: center;
        padding: 3rem 1rem;
        display: none;
    }

    .success-section.show {
        display: block;
    }

    .success-icon {
        width: 4rem;
        height: 4rem;
        margin: 0 auto 1.5rem;
        color: #60e1e0;
    }

    .success-title {
        font-size: 1.875rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 1rem;
    }

    .success-text {
        font-size: 1.125rem;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .success-subtext {
        color: #6b7280;
    }

    .disclaimer {
        text-align: center;
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 1.5rem;
    }

    .slider-container {
        width: 100%;
    }

    .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .slider-value {
        font-weight: 600;
        color: #155263;
        font-size: 1.125rem;
    }

    .form-slider {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: rgba(209, 213, 219, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        outline: none;
        -webkit-appearance: none;
    }

    .form-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #155263;
        cursor: pointer;
        transition: background 0.2s;
    }

    .form-slider::-webkit-slider-thumb:hover {
        background: #0d3a45;
    }

    .form-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #155263;
        cursor: pointer;
        border: none;
        transition: background 0.2s;
    }

    .form-slider::-moz-range-thumb:hover {
        background: #0d3a45;
    }

    .financing-section {
        background: rgba(240, 249, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(96, 225, 224, 0.3);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 16px rgba(96, 225, 224, 0.1);
    }

    .financing-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #155263;
        margin-bottom: 0.5rem;
    }

    .financing-subtitle {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 1.5rem;
    }
</style>

<div class="solar-calculator">
    <div class="calc-card">
        <div class="calc-header">
            <h1 class="calc-title">All in one Solar System & Financing Calculator</h1>
            <p class="calc-subtitle">Find out what solar system you can afford through green lending</p>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Typical Summer Power Bill ($NZ/month) *</label>
                <input type="text" id="summerPowerBill" class="form-input" placeholder="300">
                <span class="error-message" id="error-summerPowerBill"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Summer kWh Usage (Look for kWh on page 2 of your power bill)</label>
                <input type="text" id="summerKwh" class="form-input" placeholder="500">
                <span class="error-message" id="error-summerKwh"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Typical Winter Power Bill ($NZ/month) *</label>
                <input type="text" id="winterPowerBill" class="form-input" placeholder="400">
                <span class="error-message" id="error-winterPowerBill"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Winter kWh Usage (Look for kWh on page 2 of your power bill)</label>
                <input type="text" id="winterKwh" class="form-input" placeholder="1100">
                <span class="error-message" id="error-winterKwh"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Fixed Daily Charge (Add GST to the figure on your bill)</label>
                <input type="text" id="dailyCharge" class="form-input" placeholder="3.00" step="0.01">
                <span class="error-message" id="error-dailyCharge"></span>
            </div>
        </div>

        <div class="financing-section">
            <h3 class="financing-title">Financial Information (optional)</h3>
            <p class="financing-subtitle">Provide your financial details to see your borrowing power and solar financing options, using formulas provided by our financial advisor partners. If left blank, we'll focus on solar savings calculations.</p>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Annual Household Income ($NZ) (optional)</label>
                    <input type="text" id="householdIncome" class="form-input" placeholder="120,000">
                    <span class="error-message" id="error-householdIncome"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Current Property Value ($NZ) (optional)</label>
                    <input type="text" id="propertyValue" class="form-input" placeholder="800,000">
                    <span class="error-message" id="error-propertyValue"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Current Lending/Mortgage ($NZ) (optional)</label>
                    <input type="text" id="currentLending" class="form-input" placeholder="500,000">
                </div>

                <div class="form-group">
                    <label class="form-label">Household Expenses ($NZ) (optional)</label>
                    <input type="text" id="expenseAmount" class="form-input" placeholder="3,000">
                </div>

                <div class="form-group">
                    <label class="form-label">Expense Frequency (optional)</label>
                    <select id="expenseFrequency" class="form-input">
                        <option value="weekly">Weekly</option>
                        <option value="fortnightly">Fortnightly</option>
                        <option value="monthly" selected>Monthly</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="form-label">Loan Term (optional)</label>
                            <span class="slider-value" id="loanTermValue">Cash</span>
                        </div>
                        <input type="range" id="loanTerm" class="form-slider" min="0" max="20" value="0" step="1">
                    </div>
                </div>

                <div class="form-group">
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="form-label">Annual Interest Rate (optional)</label>
                            <span class="slider-value" id="interestRateValue">1.0%</span>
                        </div>
                        <input type="range" id="interestRate" class="form-slider" min="0" max="30" value="1" step="0.1">
                    </div>
                </div>
            </div>
        </div>

        <div class="tip-box">
            <p><strong>Tip:</strong> For the most accurate solar system sizing and savings calculations, please provide your kWh usage from your power bills (typically found on page 2). If you also enter your fixed daily charge, we can calculate your exact cost per kWh and provide detailed system recommendations including panel-only and panel+battery options.</p>
        </div>

        <div id="results" class="results-section"></div>

        <div id="contactForm" class="contact-section">
            <h2 class="contact-title">Unlock Your Solar Financing Options</h2>

            <div class="green-loan-highlight">
                <div class="highlight-icon">ðŸ’°</div>
                <div class="highlight-text">
                    <p style="margin: 0; font-size: 0.95rem; line-height: 1.6;">Major banks are offering green loans at <strong>1% or even 0% interest</strong> to help Kiwis go solar. Plus, you may qualify for <strong>cashback incentives</strong> when refinancing your mortgage to include solar. Our financial advisor partners can help guide you through your finance options and make the top-up or refinance process easy.</p>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">First Name *</label>
                    <input type="text" id="firstName" class="form-input">
                    <span class="error-message" id="error-firstName"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Last Name *</label>
                    <input type="text" id="lastName" class="form-input">
                    <span class="error-message" id="error-lastName"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" id="email" class="form-input">
                    <span class="error-message" id="error-email"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" id="phone" class="form-input" placeholder="021 234 5678">
                    <span class="error-message" id="error-phone"></span>
                </div>

                <!-- Honeypot fields for bot detection -->
                <div style="position: absolute; left: -5000px; opacity: 0; pointer-events: none;" aria-hidden="true">
                    <label>
                        <input type="checkbox" id="agreeToDisagree" name="agreeToDisagree" tabindex="-1" autocomplete="off">
                        Agree to disagree
                    </label>
                    <input type="text" id="city" name="city" tabindex="-1" autocomplete="off" placeholder="City">
                    <input type="text" id="honeypotTimestamp" name="timestamp" tabindex="-1" autocomplete="off">
                </div>

                <!-- Hidden field for calculator version (for Zapier validation) -->
                <input type="hidden" id="calculatorVersion" name="calculator_version" value="">

                <div class="form-group" style="grid-column: 1 / -1;">
                    <button type="button" id="submitBtn" class="submit-btn">Request A Callback</button>
                </div>
            </div>
        </div>

        <div id="successMessage" class="success-section">
            <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <h2 class="success-title">Thank You!</h2>
            <p class="success-text">Your information has been received.</p>
            <p class="success-subtext">Someone will be in touch shortly to talk through your solar financing options.</p>
        </div>

        <p class="disclaimer">* Calculator provides estimates only. Actual lending subject to bank approval.</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
    'use strict';

    // Calculator Version
    // To update: Create a git tag with version number (e.g., git tag v1.0.0)
    // Version format: ESB_solar-calculator-v{version}
    var CALCULATOR_VERSION = '1.0.0';
    var CALCULATOR_NAME = 'ESB_solar-calculator-v' + CALCULATOR_VERSION;

    // Initialize DataLayer if not exists
    window.dataLayer = window.dataLayer || [];

    // Push calculator initialization event
    window.dataLayer.push({
        'event': 'calculator_loaded',
        'calculator_name': CALCULATOR_NAME,
        'calculator_version': CALCULATOR_VERSION,
        'timestamp': new Date().toISOString()
    });

    var calculationTimer = null;
    var validationTimers = {};
    var resultsData = null;
    var chartInstance = null;
    var financingChartInstance = null;
    var costBreakdownChartInstance = null;
    var selectedSystem = 'panel-battery'; // Default to panel-battery
    var finalSystemSelection = 'panel-battery'; // Track final selection for form submission

    // Security: Rate limiting
    var lastSubmitTime = 0;
    var SUBMIT_COOLDOWN = 60000; // 1 minute between submissions
    var pageLoadTime = Date.now();

    var rawValues = {
        householdIncome: '',
        propertyValue: '',
        currentLending: '',
        expenseAmount: '',
        summerPowerBill: '',
        winterPowerBill: '',
        summerKwh: '',
        winterKwh: '',
        dailyCharge: '',
        loanTerm: 0,
        interestRate: 1.0
    };

    function formatNumber(num) {
        if (!num && num !== 0) return '0';
        var parsed = parseFloat(num);
        if (isNaN(parsed) || !isFinite(parsed)) return '0';
        return parsed.toLocaleString('en-NZ');
    }

    function formatCurrency(value) {
        if (!value) return '';
        var digits = value.replace(/\D/g, '');
        return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Security: Input sanitization to prevent XSS
    function sanitizeInput(input) {
        if (typeof input !== 'string') return input;
        return input
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;')
            .replace(/\//g, '&#x2F;');
    }

    function validateField(fieldId, rawValue) {
        clearTimeout(validationTimers[fieldId]);

        validationTimers[fieldId] = setTimeout(function() {
            var errorEl = document.getElementById('error-' + fieldId);
            var inputEl = document.getElementById(fieldId);
            var numValue = parseFloat(rawValue);

            var error = '';

            switch(fieldId) {
                case 'householdIncome':
                    if (numValue > 5000000) {
                        error = "Whoa there, Scrooge McDuck! Double-check this figure - that's a lot of zeros!";
                    }
                    break;
                case 'summerPowerBill':
                case 'winterPowerBill':
                    if (numValue > 0 && numValue < 50) {
                        error = "Really? Less than $50? Why do you even need solar with that power bill!";
                    } else if (numValue > 2000) {
                        error = "That's a serious power bill! Solar will definitely help, but double-check this number.";
                    }
                    break;
                case 'propertyValue':
                    if (numValue > 0 && numValue < 100000) {
                        error = "Is this a very cozy studio or a typo? NZ property values are usually a bit higher!";
                    } else if (numValue > 20000000) {
                        error = "Mansion alert! That's quite the palace - mind double-checking?";
                    }
                    break;
            }

            if (error) {
                errorEl.textContent = error;
                errorEl.classList.add('show');
                inputEl.classList.add('error');
            } else {
                errorEl.classList.remove('show');
                inputEl.classList.remove('error');
            }
        }, 2000);
    }

    function setupInputs() {
        var currencyFields = ['householdIncome', 'propertyValue', 'currentLending', 'expenseAmount', 'summerPowerBill', 'winterPowerBill', 'summerKwh', 'winterKwh'];

        currencyFields.forEach(function(id) {
            var input = document.getElementById(id);
            if (!input) return;

            input.addEventListener('input', function(e) {
                var digits = e.target.value.replace(/\D/g, '');
                rawValues[id] = digits;
                e.target.value = formatCurrency(digits);
                validateField(id, digits);
                scheduleCalculation();
            });
        });

        // Daily charge field with decimal support
        var dailyChargeInput = document.getElementById('dailyCharge');
        if (dailyChargeInput) {
            dailyChargeInput.addEventListener('input', function(e) {
                // Allow digits, decimal point, and limit to 2 decimal places
                var value = e.target.value;
                // Remove everything except digits and decimal point
                value = value.replace(/[^\d.]/g, '');
                // Allow only one decimal point
                var parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                // Limit to 2 decimal places
                if (parts.length === 2 && parts[1].length > 2) {
                    value = parts[0] + '.' + parts[1].substring(0, 2);
                }
                rawValues.dailyCharge = value;
                e.target.value = value;
                validateField('dailyCharge', value);
                scheduleCalculation();
            });
        }

        var expenseFreq = document.getElementById('expenseFrequency');
        if (expenseFreq) {
            expenseFreq.addEventListener('change', scheduleCalculation);
        }

        // Loan term slider
        var loanTermSlider = document.getElementById('loanTerm');
        var loanTermValue = document.getElementById('loanTermValue');
        if (loanTermSlider && loanTermValue) {
            loanTermSlider.addEventListener('input', function(e) {
                var value = parseInt(e.target.value);
                rawValues.loanTerm = value;
                if (value === 0) {
                    loanTermValue.textContent = 'Cash';
                } else {
                    loanTermValue.textContent = value + (value === 1 ? ' year' : ' years');
                }

                // Track financing option change
                window.dataLayer.push({
                    'event': 'financing_option_changed',
                    'calculator_name': CALCULATOR_NAME,
                    'calculator_version': CALCULATOR_VERSION,
                    'option_type': 'loan_term',
                    'loan_term': value,
                    'is_cash': value === 0,
                    'timestamp': new Date().toISOString()
                });

                scheduleCalculation();
            });
        }

        // Interest rate slider
        var interestRateSlider = document.getElementById('interestRate');
        var interestRateValue = document.getElementById('interestRateValue');
        if (interestRateSlider && interestRateValue) {
            interestRateSlider.addEventListener('input', function(e) {
                var value = parseFloat(e.target.value);
                rawValues.interestRate = value;
                interestRateValue.textContent = value.toFixed(1) + '%';

                // Track financing option change
                window.dataLayer.push({
                    'event': 'financing_option_changed',
                    'calculator_name': CALCULATOR_NAME,
                    'calculator_version': CALCULATOR_VERSION,
                    'option_type': 'interest_rate',
                    'interest_rate': value,
                    'timestamp': new Date().toISOString()
                });

                scheduleCalculation();
            });
        }
    }

    function scheduleCalculation() {
        clearTimeout(calculationTimer);

        // Trigger calculations if power bill data is provided (minimum required)
        if (rawValues.summerPowerBill && rawValues.winterPowerBill) {
            calculationTimer = setTimeout(function() {
                calculateResults();
            }, 2000);
        }
    }

    // Function to generate chart data for a specific system
    function generateSystemChartData(system, annualPowerCost, annualPriceIncrease, isFinanced, loanTerm, interestRate) {
        var systemCost = system.systemCost;
        var annualSavings = system.annualSavings;

        // Calculate financing for this system
        var monthlyLoanPayment = 0;
        if (isFinanced && loanTerm > 0) {
            var monthlyRate = interestRate / 100 / 12;
            var numPayments = loanTerm * 12;
            monthlyLoanPayment = systemCost * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        var chartData = [];
        var financingData = [];
        var cumulativeSolarSavings = 0;
        var cumulativePowerCostWithoutSolar = 0;
        var cumulativePowerCostWithSolar = isFinanced ? 0 : systemCost;
        var cumulativeFinancingCost = 0;

        // Calculate percentage based on system coverage (110% or 120%)
        var effectiveCoverage = (system.selfConsumptionPercent / 100) * (system.monthlyGeneration / (annualPowerCost / 12 / (annualPowerCost / (system.monthlyGeneration * 12))));

        for (var year = 0; year <= 25; year++) {
            var yearlyPowerCost = annualPowerCost * Math.pow(1 + annualPriceIncrease, year);

            // Apply panel efficiency degradation (0.5% per year)
            var panelDegradation = Math.pow(0.995, year); // 0.5% degradation per year
            var yearlySolarSavings = annualSavings * Math.pow(1 + annualPriceIncrease, year) * panelDegradation;

            // Calculate financing costs for this year
            var yearlyFinancingCost = 0;
            if (isFinanced && year > 0 && year <= loanTerm) {
                yearlyFinancingCost = monthlyLoanPayment * 12;
            }

            if (year > 0) {
                cumulativeSolarSavings += yearlySolarSavings;
                cumulativePowerCostWithoutSolar += yearlyPowerCost;
                // Only add positive net costs (prevent negative cumulative when solar saves more than power costs)
                var netYearlyCost = Math.max(0, yearlyPowerCost - yearlySolarSavings);
                cumulativePowerCostWithSolar += netYearlyCost;
                cumulativeFinancingCost += yearlyFinancingCost;
            }

            chartData.push({
                year: year,
                withoutSolar: Math.round(cumulativePowerCostWithoutSolar),
                withSolar: Math.round(cumulativePowerCostWithSolar + (isFinanced ? cumulativeFinancingCost : 0))
            });

            financingData.push({
                year: year,
                solarSavings: Math.round(cumulativeSolarSavings),
                financingCost: Math.round(cumulativeFinancingCost)
            });
        }

        return {
            chartData: chartData,
            financingData: financingData
        };
    }

    function calculateResults() {
        // Parse financial inputs (use 0 as default if not provided)
        var income = parseFloat(rawValues.householdIncome) || 0;
        var propertyValue = parseFloat(rawValues.propertyValue) || 0;
        var currentLending = parseFloat(rawValues.currentLending) || 0;
        var expenseAmount = parseFloat(rawValues.expenseAmount) || 0;

        // Check if user provided financial data
        var hasFinancialData = income > 0 && propertyValue > 0 && expenseAmount > 0;

        // Initialize financial metrics with defaults
        var monthlyExpenses = 0;
        var monthlyIncome = 0;
        var currentMonthlyPayment = 0;
        var monthlySurplus = 0;
        var lvr = 0;
        var availableEquity = 0;
        var hasSufficientSurplus = false;
        var solarReady = false;
        var solarReadyMessage = 'Provide financial information to see your borrowing power and financing options.';
        var borrowingPower = 'unknown';
        var borrowingPowerText = 'Not Provided';
        var borrowingPowerDesc = 'Enter financial details to calculate';

        // Only calculate financial metrics if user provided the data
        if (hasFinancialData) {
            var expenseFreq = document.getElementById('expenseFrequency').value;
            monthlyExpenses = expenseAmount;
            if (expenseFreq === 'weekly') {
                monthlyExpenses = expenseAmount * 52 / 12;
            } else if (expenseFreq === 'fortnightly') {
                monthlyExpenses = expenseAmount * 26 / 12;
            }

            var monthlyIncome = income / 12;
            var testRate = 0.068;
            var monthlyRate = testRate / 12;
            var numPayments = 30 * 12;

            var currentMonthlyPayment = 0;
            if (currentLending > 0) {
                currentMonthlyPayment = currentLending * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                                        (Math.pow(1 + monthlyRate, numPayments) - 1);
            }

            monthlySurplus = monthlyIncome - monthlyExpenses - currentMonthlyPayment;
            lvr = propertyValue > 0 ? (currentLending / propertyValue) * 100 : 0;
            var maxLending = propertyValue * 0.80;
            availableEquity = maxLending - currentLending;
            var hasSufficientSurplus = monthlySurplus > 500;

            if (availableEquity >= 20000 && hasSufficientSurplus) {
                solarReady = true;
                solarReadyMessage = 'Great news! You have sufficient equity and monthly surplus to proceed with solar financing.';
            } else if (availableEquity < 20000) {
                solarReady = false;
                solarReadyMessage = 'Additional equity needed to qualify for solar financing. You need at least $20,000 in available equity.';
            } else if (!hasSufficientSurplus) {
                solarReady = false;
                solarReadyMessage = 'Your equity looks good, but your monthly surplus may restrict financing options. A healthy surplus is needed after refinancing to ensure serviceability.';
            }

            borrowingPower = 'low';
            borrowingPowerText = 'Low';
            borrowingPowerDesc = 'Less than $20,000 available';

            if (availableEquity >= 50000) {
                borrowingPower = 'high';
                borrowingPowerText = 'High';
                borrowingPowerDesc = 'Over $50,000 available';
            } else if (availableEquity >= 20000) {
                borrowingPower = 'medium';
                borrowingPowerText = 'Medium';
                borrowingPowerDesc = '$20,000 - $50,000 available';
            }
        }

        var summerBill = parseFloat(rawValues.summerPowerBill) || 0;
        var winterBill = parseFloat(rawValues.winterPowerBill) || 0;
        var summerKwh = parseFloat(rawValues.summerKwh) || 0;
        var winterKwh = parseFloat(rawValues.winterKwh) || 0;
        var dailyCharge = parseFloat(rawValues.dailyCharge) || 0;

        var annualPowerCost;
        var annualDailyCharges = dailyCharge * 365;
        var annualUsageCost = 0;
        var avgMonthlyKwh = 0;
        var costPerKwh = 0;
        var calculationMethod = 'expenses';

        if (summerBill > 0 && winterBill > 0) {
            var avgMonthlyBill = (summerBill + winterBill) / 2;
            annualPowerCost = avgMonthlyBill * 12;
            calculationMethod = 'bills';

            // Calculate kWh-based metrics if kWh data is provided
            if (summerKwh > 0 && winterKwh > 0) {
                avgMonthlyKwh = (summerKwh + winterKwh) / 2;
                var annualKwh = avgMonthlyKwh * 12;
                annualUsageCost = annualPowerCost - annualDailyCharges;

                // Ensure we have valid data for cost per kWh calculation
                if (annualKwh > 0 && annualUsageCost > 0) {
                    costPerKwh = annualUsageCost / annualKwh;
                    calculationMethod = 'kwh';
                }
            }
        } else if (monthlyExpenses > 0) {
            // Fallback to expense-based estimation if financial data provided but no power bills
            var monthlyPowerCost = monthlyExpenses * 0.05;
            annualPowerCost = monthlyPowerCost * 12;
        } else {
            // Default placeholder if no power bills or financial data
            annualPowerCost = 4200; // Placeholder: $350/month average
        }

        // System sizing based on kWh usage (if available)
        var panelOnlySystem = null;
        var panelBatterySystem = null;

        if (avgMonthlyKwh > 0 && costPerKwh > 0) {
            var annualKwhUsage = avgMonthlyKwh * 12;
            var panelWattage = 460; // 460W panels
            var dailyGenerationPerKw = 3.7; // kWh per day per kW of system size
            var daysPerMonth = 30.416; // Average days per month
            var exportRate = 0.17; // 17c per kWh export rate
            var savings25YearMultiplier = 38.55; // Geometric series multiplier for 3% annual price increase over 25 years

            // Panel-only system (110% of annual usage)
            var panelOnlyTargetMonthlyGeneration = avgMonthlyKwh * 1.10;

            // Calculate required system size: monthly generation / (3.7 kWh/kW/day * 30.416 days/month)
            var panelOnlyRequiredKw = panelOnlyTargetMonthlyGeneration / (dailyGenerationPerKw * daysPerMonth);

            // Calculate panel count needed (round up)
            var panelOnlyPanelCount = Math.ceil(panelOnlyRequiredKw / (panelWattage / 1000));

            // Recalculate actual system kW based on rounded panel count
            var panelOnlySystemKw = (panelOnlyPanelCount * panelWattage) / 1000;

            // Recalculate actual generation based on final system size
            var panelOnlyMonthlyGeneration = panelOnlySystemKw * dailyGenerationPerKw * daysPerMonth;
            var panelOnlyAnnualGeneration = panelOnlyMonthlyGeneration * 12;

            // Calconic cost formula: panels * 675 + 3500 (increased by 5%)
            var panelOnlySystemCost = (panelOnlyPanelCount * 708.75) + 3675;

            // Calconic savings: 45% self-consumption at retail, 55% export at 17c
            var panelOnlySelfConsumption = panelOnlyMonthlyGeneration * 0.45 * costPerKwh;
            var panelOnlyExportRevenue = panelOnlyMonthlyGeneration * 0.55 * exportRate;
            var panelOnlyMonthlySavings = panelOnlySelfConsumption + panelOnlyExportRevenue;
            var panelOnlyAnnualSavings = panelOnlyMonthlySavings * 12;

            // Calculate payback period with 3% annual price inflation
            var inflationRate = 0.03;
            var cumulativeSavings = 0;
            var panelOnlyPaybackYears = 0;
            for (var year = 1; year <= 30; year++) {
                cumulativeSavings += panelOnlyAnnualSavings * Math.pow(1 + inflationRate, year - 1);
                if (cumulativeSavings >= panelOnlySystemCost) {
                    // Linear interpolation for fractional year
                    var prevSavings = cumulativeSavings - (panelOnlyAnnualSavings * Math.pow(1 + inflationRate, year - 1));
                    var yearSavings = panelOnlyAnnualSavings * Math.pow(1 + inflationRate, year - 1);
                    var remainingCost = panelOnlySystemCost - prevSavings;
                    var fraction = remainingCost / yearSavings;
                    panelOnlyPaybackYears = (year - 1) + fraction;
                    break;
                }
            }

            // Calculate 25-year savings using Calconic multiplier
            var panelOnly25YearSavings = (panelOnlyAnnualSavings * savings25YearMultiplier) - panelOnlySystemCost;

            panelOnlySystem = {
                monthlyGeneration: panelOnlyMonthlyGeneration,
                annualGeneration: panelOnlyAnnualGeneration,
                panelCount: panelOnlyPanelCount,
                systemKw: panelOnlySystemKw,
                systemCost: panelOnlySystemCost,
                monthlySavings: panelOnlyMonthlySavings,
                annualSavings: panelOnlyAnnualSavings,
                paybackYears: panelOnlyPaybackYears,
                savings25Year: panelOnly25YearSavings,
                selfConsumptionPercent: 45,
                exportPercent: 55
            };

            // Panel + Battery system (120% of annual usage)
            var panelBatteryTargetMonthlyGeneration = avgMonthlyKwh * 1.20;

            // Calculate required system size: monthly generation / (3.7 kWh/kW/day * 30.416 days/month)
            var panelBatteryRequiredKw = panelBatteryTargetMonthlyGeneration / (dailyGenerationPerKw * daysPerMonth);

            // Calculate panel count needed (round up)
            var panelBatteryPanelCount = Math.ceil(panelBatteryRequiredKw / (panelWattage / 1000));

            // Recalculate actual system kW based on rounded panel count
            var panelBatterySystemKw = (panelBatteryPanelCount * panelWattage) / 1000;

            // Recalculate actual generation based on final system size
            var panelBatteryMonthlyGeneration = panelBatterySystemKw * dailyGenerationPerKw * daysPerMonth;
            var panelBatteryAnnualGeneration = panelBatteryMonthlyGeneration * 12;

            // Calconic battery sizing: 0.55 * panel count
            var batteryKwh = Math.ceil(panelBatteryPanelCount * 0.55);

            // Calconic cost formula: (panels * 670) + (battery kWh * 850) + 6250 (increased by 5%)
            var panelBatterySystemCost = (panelBatteryPanelCount * 703.5) + (batteryKwh * 892.5) + 6562.5;

            // Calconic savings: 75% self-consumption at retail, 25% export at 17c
            var panelBatterySelfConsumption = panelBatteryMonthlyGeneration * 0.75 * costPerKwh;
            var panelBatteryExportRevenue = panelBatteryMonthlyGeneration * 0.25 * exportRate;
            var panelBatteryMonthlySavings = panelBatterySelfConsumption + panelBatteryExportRevenue;
            var panelBatteryAnnualSavings = panelBatteryMonthlySavings * 12;

            // Calculate payback period with 3% annual price inflation
            var cumulativeSavingsBattery = 0;
            var panelBatteryPaybackYears = 0;
            for (var year = 1; year <= 30; year++) {
                cumulativeSavingsBattery += panelBatteryAnnualSavings * Math.pow(1 + inflationRate, year - 1);
                if (cumulativeSavingsBattery >= panelBatterySystemCost) {
                    // Linear interpolation for fractional year
                    var prevSavingsBattery = cumulativeSavingsBattery - (panelBatteryAnnualSavings * Math.pow(1 + inflationRate, year - 1));
                    var yearSavingsBattery = panelBatteryAnnualSavings * Math.pow(1 + inflationRate, year - 1);
                    var remainingCostBattery = panelBatterySystemCost - prevSavingsBattery;
                    var fractionBattery = remainingCostBattery / yearSavingsBattery;
                    panelBatteryPaybackYears = (year - 1) + fractionBattery;
                    break;
                }
            }

            // Calculate 25-year savings using Calconic multiplier
            var panelBattery25YearSavings = (panelBatteryAnnualSavings * savings25YearMultiplier) - panelBatterySystemCost;

            panelBatterySystem = {
                monthlyGeneration: panelBatteryMonthlyGeneration,
                annualGeneration: panelBatteryAnnualGeneration,
                panelCount: panelBatteryPanelCount,
                systemKw: panelBatterySystemKw,
                batteryKwh: batteryKwh,
                systemCost: panelBatterySystemCost,
                monthlySavings: panelBatteryMonthlySavings,
                annualSavings: panelBatteryAnnualSavings,
                paybackYears: panelBatteryPaybackYears,
                savings25Year: panelBattery25YearSavings,
                selfConsumptionPercent: 75,
                exportPercent: 25
            };
        }

        // Keep original calculation for backwards compatibility
        var solarCoveragePercent = 0.80;
        var annualSolarSavings = annualPowerCost * solarCoveragePercent;
        var solarSystemCost = annualSolarSavings * 9;
        var annualPriceIncrease = 0.03; // 3% annual power price increase

        // Loan financing calculations
        var loanTerm = rawValues.loanTerm;
        var interestRate = rawValues.interestRate;
        var isFinanced = loanTerm > 0;
        var monthlyLoanPayment = 0;
        var totalLoanPayments = 0;
        var totalInterestPaid = 0;
        var paybackPeriod = 8;

        if (isFinanced) {
            var monthlyInterestRate = (interestRate / 100) / 12;
            var numLoanPayments = loanTerm * 12;

            if (monthlyInterestRate > 0) {
                // Calculate monthly payment using amortization formula
                monthlyLoanPayment = solarSystemCost * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numLoanPayments)) /
                                    (Math.pow(1 + monthlyInterestRate, numLoanPayments) - 1);
            } else {
                // If 0% interest, just divide by months
                monthlyLoanPayment = solarSystemCost / numLoanPayments;
            }

            totalLoanPayments = monthlyLoanPayment * numLoanPayments;
            totalInterestPaid = totalLoanPayments - solarSystemCost;

            // Recalculate payback period considering financing costs
            var effectiveCost = totalLoanPayments;
            paybackPeriod = Math.ceil(effectiveCost / annualSolarSavings);

            // Recalculate monthly surplus including solar loan payment
            monthlySurplus = monthlySurplus - monthlyLoanPayment;
            hasSufficientSurplus = monthlySurplus > 500;
        }

        var chartData = [];
        var financingChartData = [];
        var cumulativeSolarSavings = 0;
        var cumulativePowerCostWithoutSolar = 0;
        var cumulativePowerCostWithSolar = isFinanced ? 0 : solarSystemCost; // System cost at year 0 for cash
        var cumulativeFinancingCost = 0;

        for (var year = 0; year <= 25; year++) {
            var yearlyPowerCost = annualPowerCost * Math.pow(1 + annualPriceIncrease, year);

            // Apply panel efficiency degradation (0.5% per year)
            var panelDegradation = Math.pow(0.995, year); // 0.5% degradation per year
            var adjustedCoverage = solarCoveragePercent * panelDegradation;
            var yearlySolarSavings = yearlyPowerCost * adjustedCoverage;

            // Calculate financing costs for this year
            var yearlyFinancingCost = 0;
            if (isFinanced && year > 0 && year <= loanTerm) {
                yearlyFinancingCost = monthlyLoanPayment * 12;
            }

            if (year > 0) {
                cumulativeSolarSavings += yearlySolarSavings;
                cumulativePowerCostWithoutSolar += yearlyPowerCost;
                cumulativePowerCostWithSolar += yearlyPowerCost * (1 - adjustedCoverage);
                cumulativeFinancingCost += yearlyFinancingCost;
            }

            chartData.push({
                year: year,
                withoutSolar: Math.round(cumulativePowerCostWithoutSolar),
                withSolar: Math.round(cumulativePowerCostWithSolar + (isFinanced ? cumulativeFinancingCost : 0))
            });

            // Financing chart data: annual solar savings vs financing costs
            financingChartData.push({
                year: year,
                solarSavings: Math.round(cumulativeSolarSavings),
                financingCost: Math.round(cumulativeFinancingCost)
            });
        }

        // Calculate net savings accounting for financing
        var net25YearSavings = isFinanced ?
            (cumulativeSolarSavings - totalLoanPayments) :
            (cumulativeSolarSavings - solarSystemCost);

        // Generate chart data for both systems
        var panelOnlyChartData = null;
        var panelOnlyFinancingData = null;
        var panelBatteryChartData = null;
        var panelBatteryFinancingData = null;

        if (panelOnlySystem) {
            panelOnlyChartData = generateSystemChartData(panelOnlySystem, annualPowerCost, annualPriceIncrease, isFinanced, loanTerm, interestRate);
            panelOnlyFinancingData = panelOnlyChartData.financingData;
        }

        if (panelBatterySystem) {
            panelBatteryChartData = generateSystemChartData(panelBatterySystem, annualPowerCost, annualPriceIncrease, isFinanced, loanTerm, interestRate);
            panelBatteryFinancingData = panelBatteryChartData.financingData;
        }

        resultsData = {
            hasFinancialData: hasFinancialData,
            lvr: lvr.toFixed(2),
            solarReady: solarReady,
            solarReadyMessage: solarReadyMessage,
            hasSufficientSurplus: hasSufficientSurplus,
            borrowingPower: borrowingPower,
            borrowingPowerText: borrowingPowerText,
            borrowingPowerDesc: borrowingPowerDesc,
            monthlyIncome: monthlyIncome.toFixed(2),
            monthlyExpenses: monthlyExpenses.toFixed(2),
            currentMonthlyPayment: currentMonthlyPayment.toFixed(2),
            monthlySurplus: monthlySurplus.toFixed(2),
            estimatedPowerCost: annualPowerCost.toFixed(2),
            annualSolarSavings: annualSolarSavings.toFixed(2),
            total25YearSavings: net25YearSavings.toFixed(2),
            solarSystemCost: solarSystemCost.toFixed(2),
            calculationMethod: calculationMethod,
            chartData: chartData,
            financingChartData: financingChartData,
            isFinanced: isFinanced,
            loanTerm: loanTerm,
            interestRate: interestRate.toFixed(1),
            monthlyLoanPayment: monthlyLoanPayment.toFixed(2),
            totalLoanPayments: totalLoanPayments.toFixed(2),
            totalInterestPaid: totalInterestPaid.toFixed(2),
            paybackPeriod: paybackPeriod,
            currentLending: currentLending,
            // New kWh-based metrics
            annualDailyCharges: annualDailyCharges.toFixed(2),
            annualUsageCost: annualUsageCost.toFixed(2),
            avgMonthlyKwh: avgMonthlyKwh.toFixed(0),
            costPerKwh: costPerKwh.toFixed(4),
            panelOnlySystem: panelOnlySystem,
            panelBatterySystem: panelBatterySystem,
            panelOnlyChartData: panelOnlyChartData,
            panelOnlyFinancingData: panelOnlyFinancingData,
            panelBatteryChartData: panelBatteryChartData,
            panelBatteryFinancingData: panelBatteryFinancingData
        };

        displayResults(resultsData);
    }

    function displayResults(data) {
        var resultsDiv = document.getElementById('results');
        if (!resultsDiv) return;

        resultsDiv.classList.add('show');

        var html = '';

        // Solar Ready Status Card
        html += '<div class="result-card">';
        html += '  <div class="result-header">';
        html += '    <div style="flex: 1;">';
        html += '      <h2 class="result-title">Solar Ready Status</h2>';
        html += '      <p class="result-text">' + data.solarReadyMessage + '</p>';
        if (!data.hasSufficientSurplus) {
            html += '      <p class="result-note">Note: Low or medium borrowing power may restrict your financing options. Banks require sufficient monthly surplus to remain after any top-up or refinance is completed.</p>';
        }
        if (data.isFinanced && data.hasSufficientSurplus) {
            html += '      <p class="result-note">Monthly surplus includes the solar loan payment of $' + formatNumber(data.monthlyLoanPayment) + '/month.</p>';
        }
        html += '    </div>';
        if (data.solarReady) {
            html += '    <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        }
        html += '  </div>';
        html += '</div>';

        // Power Grid
        html += '<div class="power-grid">';
        html += '  <div class="power-card ' + data.borrowingPower + '">';
        html += '    <h3 class="power-header">Borrowing Power</h3>';
        html += '    <div class="power-content">';
        html += '      <div>';
        html += '        <p class="power-text ' + data.borrowingPower + '">' + data.borrowingPowerText + '</p>';
        html += '        <p class="power-subtext">' + data.borrowingPowerDesc + '</p>';
        html += '      </div>';
        html += '      <div class="power-dot">';

        // Determine color based on borrowing power
        var dotColor = data.borrowingPower === 'high' ? '#fbbf24' : (data.borrowingPower === 'medium' ? '#fbbf24' : '#60a5fa');

        html += '        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">';

        // Draw sun rays (12 rays around the circle)
        for (var i = 0; i < 12; i++) {
            var angle = (i * 30) * Math.PI / 180;
            var x1 = 50 + Math.cos(angle) * 38;
            var y1 = 50 + Math.sin(angle) * 38;
            var x2 = 50 + Math.cos(angle) * 48;
            var y2 = 50 + Math.sin(angle) * 48;
            html += '          <line class="sun-ray" x1="' + x1 + '" y1="' + y1 + '" x2="' + x2 + '" y2="' + y2 + '" stroke="' + dotColor + '" stroke-width="2" stroke-linecap="round" />';
        }

        // Draw donut (outer circle)
        html += '          <circle cx="50" cy="50" r="30" fill="none" stroke="' + dotColor + '" stroke-width="8" opacity="0.3"/>';

        // Draw donut fill based on power level (low=33%, medium=66%, high=100%)
        var percentage = data.borrowingPower === 'high' ? 100 : (data.borrowingPower === 'medium' ? 66 : 33);
        var circumference = 2 * Math.PI * 30;
        var fillLength = (percentage / 100) * circumference;
        var dashArray = fillLength + ' ' + circumference;

        html += '          <circle cx="50" cy="50" r="30" fill="none" stroke="' + dotColor + '" stroke-width="8" stroke-dasharray="' + dashArray + '" stroke-linecap="round"/>';

        html += '        </svg>';
        html += '      </div>';
        html += '    </div>';
        html += '  </div>';
        html += '  <div class="lvr-card">';
        html += '    <h3 class="power-header">Current LVR</h3>';
        html += '    <p class="power-text" style="color: #155263;">' + data.lvr + '%</p>';
        html += '    <p class="power-subtext">Based on 80% lending threshold</p>';
        html += '  </div>';
        html += '</div>';

        // Serviceability Card
        html += '<div class="serviceability-card">';
        html += '  <h3 class="power-header">Monthly Serviceability (at 6.8% test rate)</h3>';
        html += '  <div class="service-grid">';
        html += '    <div>';
        html += '      <div class="service-row">';
        html += '        <span class="service-label">Monthly Income:</span>';
        html += '        <span class="service-value">$' + formatNumber(data.monthlyIncome) + '</span>';
        html += '      </div>';
        html += '      <div class="service-row">';
        html += '        <span class="service-label">Monthly Expenses:</span>';
        html += '        <span class="service-value">$' + formatNumber(data.monthlyExpenses) + '</span>';
        html += '      </div>';
        html += '      <div class="service-row">';
        html += '        <span class="service-label">Current Mortgage Payment:</span>';
        html += '        <span class="service-value">$' + formatNumber(data.currentMonthlyPayment) + '</span>';
        html += '      </div>';
        if (data.isFinanced) {
            html += '      <div class="service-row">';
            html += '        <span class="service-label">Solar Loan Payment:</span>';
            html += '        <span class="service-value">$' + formatNumber(data.monthlyLoanPayment) + '</span>';
            html += '      </div>';
        }
        html += '    </div>';
        html += '    <div class="surplus-box">';
        html += '      <div>';
        html += '        <p class="power-subtext">Monthly Surplus</p>';
        var surplusColor = parseFloat(data.monthlySurplus) > 0 ? '#60e1e0' : '#155263';
        html += '        <p class="surplus-amount" style="color: ' + surplusColor + '">$' + formatNumber(data.monthlySurplus) + '</p>';
        html += '      </div>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';

        // ROI Card
        html += '<div class="roi-card">';
        html += '  <h3 class="result-title">Solar Investment Returns (25 Year Projection)</h3>';

        // Detailed kWh-based outputs (if kWh data is available)
        if (data.calculationMethod === 'kwh' && parseFloat(data.avgMonthlyKwh) > 0) {
            html += '<div class="roi-card" style="background: linear-gradient(to right, #fffef0, #ffffff); border: 2px solid #ffc93c;">';
            html += '  <h3 class="result-title">Your Power Usage Analysis</h3>';
            html += '  <div class="roi-grid">';
            html += '    <div class="roi-box yellow">';
            html += '      <p class="roi-label">Annual Power Cost</p>';
            html += '      <p class="roi-value">$' + formatNumber(data.estimatedPowerCost) + '</p>';
            html += '    </div>';
            html += '    <div class="roi-box yellow">';
            html += '      <p class="roi-label">Annual Daily Charges</p>';
            html += '      <p class="roi-value">$' + formatNumber(data.annualDailyCharges) + '</p>';
            html += '      <p class="roi-note">Fixed connection fees</p>';
            html += '    </div>';
            html += '    <div class="roi-box yellow">';
            html += '      <p class="roi-label">Annual Usage Cost</p>';
            html += '      <p class="roi-value">$' + formatNumber(data.annualUsageCost) + '</p>';
            html += '      <p class="roi-note">What you pay for power itself</p>';
            html += '    </div>';
            html += '  </div>';
            html += '  <div class="roi-grid" style="margin-top: 1rem;">';
            html += '    <div class="roi-box yellow">';
            html += '      <p class="roi-label">Average Monthly kWh Usage</p>';
            html += '      <p class="roi-value">' + data.avgMonthlyKwh + ' kWh</p>';
            html += '    </div>';
            html += '    <div class="roi-box yellow">';
            html += '      <p class="roi-label">Cost Per kWh (GST Inclusive)</p>';
            html += '      <p class="roi-value">$' + data.costPerKwh + '</p>';
            html += '    </div>';
            html += '    <div class="roi-box yellow">';
            html += '      <p class="roi-label">Your bills without solar (over 25 years)</p>';
            var projected25YearCost = parseFloat(data.estimatedPowerCost) * 38.55; // 3% inflation over 25 years
            html += '      <p class="roi-value">$' + formatNumber(projected25YearCost.toFixed(0)) + '</p>';
            html += '      <p class="roi-note">25-Year Power Cost Projection Without Solar System Install (3% Annual Price Inflation)</p>';
            html += '    </div>';
            html += '  </div>';
            html += '</div>';

            // System comparison section
            if (data.panelOnlySystem || data.panelBatterySystem) {
                html += '<h3 class="result-title" style="margin-top: 2rem; margin-bottom: 1rem; text-align: center;">Recommended Solar System Options</h3>';
                html += '<div class="system-comparison">';

                // Panel-only system
                if (data.panelOnlySystem) {
                    var sys = data.panelOnlySystem;
                    html += '<div class="system-option-card panel-only" data-system="panel-only" style="cursor: pointer;">';
                    html += '  <div class="system-option-header">';
                    html += '    <h4 class="system-option-title">';
                    html += '      <span>Solar-Only System</span>';
                    html += '      <span class="tooltip-icon">?';
                    html += '        <div class="tooltip-content">';
                    html += '          <strong>What does 110% coverage mean?</strong>';
                    html += '          <ul>';
                    html += '            <li>System generates <strong>110%</strong> of your annual kWh usage</li>';
                    html += '            <li>Only <strong>45% is self-consumed</strong> (used directly when sun shines)</li>';
                    html += '            <li><strong>55% is exported</strong> to grid at lower rate (17c/kWh vs ~40-50c retail)</li>';
                    html += '            <li>Solar only works during daytime - you still buy grid power at night</li>';
                    html += '            <li><strong>Bill coverage:</strong> ~35% winter, up to 80% summer</li>';
                    html += '            <li>Best for homes with high daytime power usage</li>';
                    html += '          </ul>';
                    html += '        </div>';
                    html += '      </span>';
                    html += '    </h4>';
                    html += '    <p class="system-option-subtitle">Generates ~110% of annual use, covering most winter daytime loads (including hot water) and driving summer bills close to zero.</p>';
                    html += '    <p class="system-option-subtitle" style="margin-top: 0.5rem; font-weight: 600; color: #155263;">Bill Impact: ~35% of winter bills; up to 100% of summer bills covered</p>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Monthly Generation Target</span>';
                    html += '    <div><span class="spec-value highlight">' + Math.round(sys.monthlyGeneration) + ' kWh</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">System Size</span>';
                    html += '    <div><span class="spec-value">' + sys.panelCount + ' panels (' + sys.systemKw.toFixed(1) + ' kW)</span><div class="spec-note">Using 460W panels</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Estimated System Cost</span>';
                    html += '    <div><span class="spec-value highlight">$' + formatNumber(sys.systemCost.toFixed(0)) + '</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Monthly Savings</span>';
                    html += '    <div><span class="spec-value">$' + formatNumber(sys.monthlySavings.toFixed(0)) + '</span><div class="spec-note">' + sys.selfConsumptionPercent + '% self-use, ' + sys.exportPercent + '% export @ 17c</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Annual Savings</span>';
                    html += '    <div><span class="spec-value">$' + formatNumber(sys.annualSavings.toFixed(0)) + '</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Payback Period</span>';
                    html += '    <div><span class="spec-value">' + sys.paybackYears.toFixed(2) + ' years</span><div class="spec-note">With 3% Annual Price Inflation</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">25-Year Net Savings</span>';
                    html += '    <div><span class="spec-value highlight" style="color: #155263;">$' + formatNumber(sys.savings25Year.toFixed(0)) + '</span><div class="spec-note">Assuming 3% annual price increase</div></div>';
                    html += '  </div>';

                    html += '</div>';
                }

                // Panel + Battery system
                if (data.panelBatterySystem) {
                    var sysBatt = data.panelBatterySystem;
                    html += '<div class="system-option-card panel-battery selected" data-system="panel-battery" style="cursor: pointer;">';
                    html += '  <div class="system-option-header">';
                    html += '    <h4 class="system-option-title">';
                    html += '      <span>Solar + Battery System</span>';
                    html += '      <span class="tooltip-icon">?';
                    html += '        <div class="tooltip-content">';
                    html += '          <strong>What does 120% coverage mean?</strong>';
                    html += '          <ul>';
                    html += '            <li>System generates <strong>120%</strong> of your annual kWh usage</li>';
                    html += '            <li><strong>75% is self-consumed</strong> (battery stores excess for night time)</li>';
                    html += '            <li>Only <strong>25% is exported</strong> to grid</li>';
                    html += '            <li>Extra 10% (vs 110%) accounts for battery charging/discharging efficiency (~10% loss)</li>';
                    html += '            <li>Battery provides power during evening/night when solar stops</li>';
                    html += '            <li><strong>Bill coverage:</strong> ~50% winter, up to 100% summer</li>';
                    html += '            <li>Better bill coverage despite needing more generation</li>';
                    html += '          </ul>';
                    html += '        </div>';
                    html += '      </span>';
                    html += '    </h4>';
                    html += '    <p class="system-option-subtitle">Generates ~120% of annual use, providing enough winter generation to charge the battery for evening use.</p>';
                    html += '    <p class="system-option-subtitle" style="margin-top: 0.5rem; font-weight: 600; color: #155263;">Bill Impact: ~50% of winter bills; potential for below-zero summer bills (subject to export limits)</p>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Monthly Generation Target</span>';
                    html += '    <div><span class="spec-value highlight">' + Math.round(sysBatt.monthlyGeneration) + ' kWh</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">System Size</span>';
                    html += '    <div><span class="spec-value">' + sysBatt.panelCount + ' panels (' + sysBatt.systemKw.toFixed(1) + ' kW)</span><div class="spec-note">Using 460W panels</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Battery Storage</span>';
                    html += '    <div><span class="spec-value">' + sysBatt.batteryKwh + ' kWh</span><div class="spec-note">Recommended capacity</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Estimated System Cost</span>';
                    html += '    <div><span class="spec-value highlight">$' + formatNumber(sysBatt.systemCost.toFixed(0)) + '</span><div class="spec-note">Including battery</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Monthly Savings</span>';
                    html += '    <div><span class="spec-value">$' + formatNumber(sysBatt.monthlySavings.toFixed(0)) + '</span><div class="spec-note">' + sysBatt.selfConsumptionPercent + '% self-use, ' + sysBatt.exportPercent + '% export @ 17c</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Annual Savings</span>';
                    html += '    <div><span class="spec-value">$' + formatNumber(sysBatt.annualSavings.toFixed(0)) + '</span></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">Payback Period</span>';
                    html += '    <div><span class="spec-value">' + sysBatt.paybackYears.toFixed(2) + ' years</span><div class="spec-note">With 3% Annual Price Inflation</div></div>';
                    html += '  </div>';

                    html += '  <div class="spec-row">';
                    html += '    <span class="spec-label">25-Year Net Savings</span>';
                    html += '    <div><span class="spec-value highlight" style="color: #155263;">$' + formatNumber(sysBatt.savings25Year.toFixed(0)) + '</span><div class="spec-note">Battery replacement not factored</div></div>';
                    html += '  </div>';

                    html += '</div>';
                }

                html += '</div>';
            }
        }

        // Financing Details (if loan is used)
        if (data.isFinanced) {
            html += '  <div class="system-cost-box" id="loanFinancingDetails" style="background-color: #f0f9ff; border-color: #60e1e0;">';
            html += '    <h3 class="result-title">Loan Financing Details</h3>';
            html += '    <div id="financingDetailsContent"></div>';
            html += '  </div>';
        }
        html += '  </div>';

        html += '  <h3 class="result-title" style="margin-top: 2rem; text-align: center;">Estimated Solar System Cost</h3>';
        html += '  <div class="system-cost-box">';
        html += '    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">';

        // System Cost
        html += '      <div style="text-align: center; padding: 1rem; background: rgba(96, 225, 224, 0.1); border-radius: 8px;">';
        html += '        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">System Cost</p>';
        html += '        <p id="dynamicSystemCost" style="font-size: 1.75rem; font-weight: bold; color: #155263; margin: 0;">$' + formatNumber(data.solarSystemCost) + '</p>';
        html += '        <p id="dynamicSystemCostNote" style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">' + (data.isFinanced ? 'Total financed: $' + formatNumber(data.totalLoanPayments) : 'Cash purchase') + '</p>';
        html += '      </div>';

        // 25-Year Net Savings
        html += '      <div style="text-align: center; padding: 1rem; background: rgba(255, 201, 60, 0.1); border-radius: 8px;">';
        html += '        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">25-Year Net Savings</p>';
        html += '        <p id="dynamic25YearSavings" style="font-size: 1.75rem; font-weight: bold; color: #155263; margin: 0;">$' + formatNumber(data.total25YearSavings) + '</p>';
        html += '        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">' + (data.isFinanced ? 'After financing costs' : 'Based on 3% inflation') + '</p>';
        html += '      </div>';

        // Solar ROI
        var solarROI = ((parseFloat(data.total25YearSavings) / parseFloat(data.solarSystemCost)) * 100).toFixed(0);
        html += '      <div style="text-align: center; padding: 1rem; background: rgba(255, 154, 118, 0.1); border-radius: 8px;">';
        html += '        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Solar ROI (25 Years)</p>';
        html += '        <p id="dynamicSolarROI" style="font-size: 1.75rem; font-weight: bold; color: #155263; margin: 0;">' + solarROI + '%</p>';
        html += '        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Return on investment</p>';
        html += '      </div>';

        html += '    </div>';

        // Add cost breakdown donut chart
        html += '    <div style="margin-top: 1.5rem; max-width: 350px; margin-left: auto; margin-right: auto;">';
        html += '      <canvas id="costBreakdownChart" style="max-height: 250px;"></canvas>';
        html += '    </div>';
        html += '    <div id="costBreakdownDetails" style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;"></div>';
        html += '  </div>';

        html += '  <h3 class="result-title" style="margin-top: 2rem;">Power Costs Over Time</h3>';
        html += '  <div class="chart-container">';
        html += '    <canvas id="solarChart"></canvas>';
        html += '  </div>';

        // Add financing chart if loan is used
        if (data.isFinanced) {
            html += '  <h3 class="result-title" style="margin-top: 2rem;">Estimated Financing Cost vs Solar Savings</h3>';
            html += '  <p class="roi-note" style="text-align: center; margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">This is a high level estimate only, compare real quotes for a better financial estimate</p>';
            html += '  <div class="chart-container">';
            html += '    <canvas id="financingChart"></canvas>';
            html += '  </div>';
        }

        html += '  <div class="assumptions-box">';
        html += '    <p><strong>Key Assumptions:</strong> Projected power price increase: 3% annually | Panel efficiency degradation: 0.5% per year | System lifespan: 25 years';
        if (data.isFinanced) {
            html += ' | Financing: ' + data.loanTerm + ' year loan @ ' + data.interestRate + '% interest';
        } else {
            html += ' | Cash purchase (no financing)';
        }
        if (data.calculationMethod === 'bills') {
            html += ' | Calculation based on your actual power bills';
        } else {
            html += ' | Power costs estimated from household expenses';
        }
        html += '</p>';
        html += '    <p style="margin-top: 0.5rem; font-style: italic;">Book a consultation to collaborate on the best solar options for your home</p>';
        html += '  </div>';
        html += '</div>';

        resultsDiv.innerHTML = html;

        // Track calculation completion in DataLayer
        var eventData = {
            'event': 'calculator_results_generated',
            'calculator_name': CALCULATOR_NAME,
            'calculator_version': CALCULATOR_VERSION,
            'is_financed': data.isFinanced,
            'loan_term': data.isFinanced ? data.loanTerm : null,
            'interest_rate': data.isFinanced ? data.interestRate : null,
            'has_panel_only': !!data.panelOnlySystem,
            'has_panel_battery': !!data.panelBatterySystem,
            'system_selected': finalSystemSelection,
            'annual_power_cost_estimate': parseFloat(data.estimatedPowerCost),
            'avg_monthly_kwh': data.avgMonthlyKwh ? parseFloat(data.avgMonthlyKwh) : null,
            'timestamp': new Date().toISOString()
        };

        // Add power bill data if available
        if (rawValues.summerPowerBill && parseFloat(rawValues.summerPowerBill) > 0) {
            eventData.power_bill_summer = parseFloat(rawValues.summerPowerBill);
        }
        if (rawValues.winterPowerBill && parseFloat(rawValues.winterPowerBill) > 0) {
            eventData.power_bill_winter = parseFloat(rawValues.winterPowerBill);
        }

        // Add kWh data if available
        if (rawValues.summerKwh && parseFloat(rawValues.summerKwh) > 0) {
            eventData.summer_kwh = parseFloat(rawValues.summerKwh);
        }
        if (rawValues.winterKwh && parseFloat(rawValues.winterKwh) > 0) {
            eventData.winter_kwh = parseFloat(rawValues.winterKwh);
        }

        // Add panel-only system data if available
        if (data.panelOnlySystem) {
            eventData.panel_only_system_kw = parseFloat(data.panelOnlySystem.systemKw.toFixed(1));
            eventData.panel_only_panel_count = data.panelOnlySystem.panelCount;
            eventData.panel_only_system_cost = parseFloat(data.panelOnlySystem.systemCost.toFixed(0));
            eventData.panel_only_monthly_generation_kwh = parseFloat(data.panelOnlySystem.monthlyGeneration.toFixed(0));
            eventData.panel_only_annual_generation_kwh = parseFloat(data.panelOnlySystem.annualGeneration.toFixed(0));
            eventData.panel_only_monthly_savings = parseFloat(data.panelOnlySystem.monthlySavings.toFixed(0));
            eventData.panel_only_annual_savings = parseFloat(data.panelOnlySystem.annualSavings.toFixed(0));
            eventData.panel_only_payback_years = parseFloat(data.panelOnlySystem.paybackYears.toFixed(2));
            eventData.panel_only_25year_net_savings = parseFloat(data.panelOnlySystem.savings25Year.toFixed(0));
            eventData.panel_only_self_consumption_percent = data.panelOnlySystem.selfConsumptionPercent;
            eventData.panel_only_export_percent = data.panelOnlySystem.exportPercent;
        }

        // Add battery system data if available
        if (data.panelBatterySystem) {
            eventData.battery_system_kw = parseFloat(data.panelBatterySystem.systemKw.toFixed(1));
            eventData.battery_panel_count = data.panelBatterySystem.panelCount;
            eventData.battery_kwh_capacity = data.panelBatterySystem.batteryKwh;
            eventData.battery_system_cost = parseFloat(data.panelBatterySystem.systemCost.toFixed(0));
            eventData.battery_monthly_generation_kwh = parseFloat(data.panelBatterySystem.monthlyGeneration.toFixed(0));
            eventData.battery_annual_generation_kwh = parseFloat(data.panelBatterySystem.annualGeneration.toFixed(0));
            eventData.battery_monthly_savings = parseFloat(data.panelBatterySystem.monthlySavings.toFixed(0));
            eventData.battery_annual_savings = parseFloat(data.panelBatterySystem.annualSavings.toFixed(0));
            eventData.battery_payback_years = parseFloat(data.panelBatterySystem.paybackYears.toFixed(2));
            eventData.battery_25year_net_savings = parseFloat(data.panelBatterySystem.savings25Year.toFixed(0));
            eventData.battery_self_consumption_percent = data.panelBatterySystem.selfConsumptionPercent;
            eventData.battery_export_percent = data.panelBatterySystem.exportPercent;
        }

        window.dataLayer.push(eventData);

        // Destroy existing charts
        if (chartInstance) {
            chartInstance.destroy();
        }
        if (financingChartInstance) {
            financingChartInstance.destroy();
        }
        if (costBreakdownChartInstance) {
            costBreakdownChartInstance.destroy();
        }

        // Create main savings chart
        var ctx = document.getElementById('solarChart');
        if (ctx && typeof Chart !== 'undefined') {
            var chartLabel = data.isFinanced ? 'With Solar (inc. financing)' : 'With Solar (inc. system cost)';
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chartData.map(function(d) { return d.year; }),
                    datasets: [
                        {
                            label: 'Without Solar',
                            data: data.chartData.map(function(d) { return d.withoutSolar; }),
                            borderColor: '#60e1e0',
                            backgroundColor: 'rgba(96, 225, 224, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: chartLabel,
                            data: data.chartData.map(function(d) { return d.withSolar; }),
                            borderColor: '#ffc93c',
                            backgroundColor: 'rgba(255, 201, 60, 0.2)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatNumber(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            }
                        }
                    }
                }
            });
        }

        // Create financing chart if applicable
        if (data.isFinanced) {
            var financingCtx = document.getElementById('financingChart');
            if (financingCtx && typeof Chart !== 'undefined') {
                // Get financing data for selected system
                var financingData;
                if (selectedSystem === 'panel-battery' && data.panelBatteryFinancingData) {
                    financingData = data.panelBatteryFinancingData;
                } else if (selectedSystem === 'panel-only' && data.panelOnlyFinancingData) {
                    financingData = data.panelOnlyFinancingData;
                } else {
                    financingData = data.financingChartData;
                }

                // Only create chart if we have financing data
                if (financingData && financingData.length > 0) {
                    // Build datasets array - only high-level estimates
                    var financingDatasets = [
                        {
                            label: 'Cumulative Solar Savings',
                            data: financingData.map(function(d) { return d.solarSavings; }),
                            borderColor: '#60e1e0',
                            backgroundColor: 'rgba(96, 225, 224, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Cumulative Financing Cost',
                            data: financingData.map(function(d) { return d.financingCost; }),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.2)',
                            fill: true,
                            tension: 0.1
                        }
                    ];

                    financingChartInstance = new Chart(financingCtx, {
                        type: 'line',
                        data: {
                            labels: financingData.map(function(d) { return d.year; }),
                            datasets: financingDatasets
                        },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + formatNumber(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + formatNumber(value);
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Years'
                                }
                            }
                        }
                    }
                });
                }
            }
        }

        // Create cost breakdown chart based on selected system
        createCostBreakdownChart(data);

        // Update financing details based on selected system
        updateFinancingDetails(data);

        // Update system cost metrics based on selected system
        updateSystemCostMetrics(data);

        // Update main charts based on selected system
        updateMainCharts(data);

        // Add click handlers for system option cards
        var systemCards = document.querySelectorAll('.system-option-card');
        systemCards.forEach(function(card) {
            card.addEventListener('click', function() {
                var systemType = this.getAttribute('data-system');
                var previousSelection = selectedSystem;
                selectedSystem = systemType;
                finalSystemSelection = systemType; // Track for form submission

                // Track system selection in DataLayer
                var systemData = systemType === 'panel-battery' ? data.panelBatterySystem : data.panelOnlySystem;
                var eventData = {
                    'event': 'system_selected',
                    'calculator_name': CALCULATOR_NAME,
                    'calculator_version': CALCULATOR_VERSION,
                    'system_type': systemType,
                    'system_cost': systemData ? systemData.systemCost : null,
                    'panel_count': systemData ? systemData.panelCount : null,
                    'has_battery': systemType === 'panel-battery',
                    'annual_savings': systemData ? systemData.annualSavings : null,
                    'timestamp': new Date().toISOString()
                };

                // Add power bill data if available
                if (rawValues.summerPowerBill && parseFloat(rawValues.summerPowerBill) > 0) {
                    eventData.power_bill_summer = rawValues.summerPowerBill;
                }
                if (rawValues.winterPowerBill && parseFloat(rawValues.winterPowerBill) > 0) {
                    eventData.power_bill_winter = rawValues.winterPowerBill;
                }

                // Add kWh data if available
                if (rawValues.summerKwh && parseFloat(rawValues.summerKwh) > 0) {
                    eventData.summer_kwh = rawValues.summerKwh;
                }
                if (rawValues.winterKwh && parseFloat(rawValues.winterKwh) > 0) {
                    eventData.winter_kwh = rawValues.winterKwh;
                }

                window.dataLayer.push(eventData);

                // If this is a toggle (not initial selection), fire additional toggle event
                if (previousSelection !== systemType) {
                    window.dataLayer.push({
                        'event': 'system_toggled',
                        'calculator_name': CALCULATOR_NAME,
                        'calculator_version': CALCULATOR_VERSION,
                        'from_system': previousSelection,
                        'to_system': systemType,
                        'timestamp': new Date().toISOString()
                    });
                }

                // Update selected state
                systemCards.forEach(function(c) { c.classList.remove('selected'); });
                this.classList.add('selected');

                // Update cost breakdown chart
                createCostBreakdownChart(data);

                // Update financing details
                updateFinancingDetails(data);

                // Update system cost metrics
                updateSystemCostMetrics(data);

                // Update main charts
                updateMainCharts(data);
            });
        });
    }

    // Function to update main charts based on selected system
    function updateMainCharts(data) {
        var currentChartData, currentFinancingData;

        // Get data for selected system
        if (selectedSystem === 'panel-battery' && data.panelBatteryChartData) {
            currentChartData = data.panelBatteryChartData.chartData;
            currentFinancingData = data.panelBatteryFinancingData;
        } else if (selectedSystem === 'panel-only' && data.panelOnlyChartData) {
            currentChartData = data.panelOnlyChartData.chartData;
            currentFinancingData = data.panelOnlyFinancingData;
        } else {
            // Fallback to generic chart data
            currentChartData = data.chartData;
            currentFinancingData = data.financingChartData;
        }

        // Update main savings chart
        if (chartInstance && currentChartData) {
            chartInstance.data.datasets[0].data = currentChartData.map(function(d) { return d.withoutSolar; });
            chartInstance.data.datasets[1].data = currentChartData.map(function(d) { return d.withSolar; });
            chartInstance.update();
        }

        // Update financing chart
        if (financingChartInstance && currentFinancingData && data.isFinanced) {
            financingChartInstance.data.datasets[0].data = currentFinancingData.map(function(d) { return d.solarSavings; });
            financingChartInstance.data.datasets[1].data = currentFinancingData.map(function(d) { return d.financingCost; });
            financingChartInstance.update();
        }
    }

    // Function to update financing details based on selected system
    function updateFinancingDetails(data) {
        var financingDetailsDiv = document.getElementById('financingDetailsContent');
        if (!financingDetailsDiv || !data.isFinanced) return;

        // Get the selected system data
        var systemData = selectedSystem === 'panel-battery' ? data.panelBatterySystem : data.panelOnlySystem;
        if (!systemData) return;

        // Calculate financing for selected system
        var systemCost = systemData.systemCost;
        var loanTerm = parseInt(data.loanTerm) || 0;
        var interestRate = parseFloat(data.interestRate) || 0;

        if (loanTerm <= 0) return;

        var monthlyRate = interestRate / 100 / 12;
        var numPayments = loanTerm * 12;
        var monthlyPayment = systemCost * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
        var totalPayments = monthlyPayment * numPayments;
        var totalInterest = totalPayments - systemCost;

        // Calculate bank cashback at 1% of current lending/mortgage
        var currentLending = parseFloat(data.currentLending) || 0;
        var bankCashback = currentLending * 0.01;

        var html = '';
        html += '<div class="roi-grid" style="margin-bottom: 0;">';
        html += '  <div>';
        html += '    <p class="roi-note" style="margin-bottom: 0.25rem;">Monthly Payment</p>';
        html += '    <p class="roi-value" style="font-size: 1.25rem;">$' + formatNumber(monthlyPayment.toFixed(2)) + '</p>';
        html += '  </div>';
        html += '  <div>';
        html += '    <p class="roi-note" style="margin-bottom: 0.25rem;">Loan Term</p>';
        html += '    <p class="roi-value" style="font-size: 1.25rem;">' + loanTerm + ' years @ ' + interestRate.toFixed(1) + '%</p>';
        html += '  </div>';
        html += '  <div>';
        html += '    <p class="roi-note" style="margin-bottom: 0.25rem;">Total Interest Paid</p>';
        html += '    <p class="roi-value" style="font-size: 1.25rem;">$' + formatNumber(totalInterest.toFixed(2)) + '</p>';
        html += '  </div>';
        html += '  <div>';
        html += '    <p class="roi-note" style="margin-bottom: 0.25rem;">Bank Cashback (1% of Current Lending)</p>';
        html += '    <p class="roi-value" style="font-size: 1.25rem; color: #16a34a;">$' + formatNumber(bankCashback.toFixed(0)) + '</p>';
        html += '  </div>';
        html += '</div>';

        financingDetailsDiv.innerHTML = html;
    }

    // Function to update system cost metrics based on selected system
    function updateSystemCostMetrics(data) {
        var systemCostEl = document.getElementById('dynamicSystemCost');
        var systemCostNoteEl = document.getElementById('dynamicSystemCostNote');
        var savings25YearEl = document.getElementById('dynamic25YearSavings');
        var solarROIEl = document.getElementById('dynamicSolarROI');

        if (!systemCostEl || !data) return;

        // Get the selected system data
        var systemData = selectedSystem === 'panel-battery' ? data.panelBatterySystem : data.panelOnlySystem;
        if (!systemData) return;

        var systemCost = systemData.systemCost;
        var savings25Year = systemData.savings25Year;

        // Calculate financing if applicable
        var totalFinancedCost = systemCost;
        if (data.isFinanced) {
            var loanTerm = data.loanTerm;
            var interestRate = data.interestRate;
            var monthlyRate = interestRate / 100 / 12;
            var numPayments = loanTerm * 12;
            var monthlyPayment = systemCost * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            totalFinancedCost = monthlyPayment * numPayments;
        }

        // Calculate Solar ROI
        var solarROI = ((savings25Year / systemCost) * 100).toFixed(0);

        // Update the display
        systemCostEl.textContent = '$' + formatNumber(systemCost.toFixed(0));
        if (systemCostNoteEl) {
            systemCostNoteEl.textContent = data.isFinanced ? 'Total financed: $' + formatNumber(totalFinancedCost.toFixed(0)) : 'Cash purchase';
        }

        if (savings25YearEl) {
            savings25YearEl.textContent = '$' + formatNumber(savings25Year.toFixed(0));
        }

        if (solarROIEl) {
            solarROIEl.textContent = solarROI + '%';
        }
    }

    // Function to create cost breakdown donut chart
    function createCostBreakdownChart(data) {
        var costCtx = document.getElementById('costBreakdownChart');
        var costDetailsDiv = document.getElementById('costBreakdownDetails');

        if (!costCtx || !data) return;

        // Destroy existing chart
        if (costBreakdownChartInstance) {
            costBreakdownChartInstance.destroy();
        }

        // Get the selected system data
        var systemData = selectedSystem === 'panel-battery' ? data.panelBatterySystem : data.panelOnlySystem;
        if (!systemData) return;

        // Calculate cost breakdown
        var panelCost, installCost, batteryCost, interestCost;

        if (selectedSystem === 'panel-battery') {
            // Panel+Battery: (panels * 670) + (battery kWh * 850) + 6250
            panelCost = systemData.panelCount * 670;
            batteryCost = systemData.batteryKwh * 850;
            installCost = 6250;
        } else {
            // Panel-only: panels * 675 + 3500
            panelCost = systemData.panelCount * 675;
            batteryCost = 0;
            installCost = 3500;
        }

        // Calculate interest if financed
        interestCost = 0;
        if (data.isFinanced) {
            var systemCost = systemData.systemCost;
            var loanTerm = data.loanTerm;
            var interestRate = data.interestRate;
            var monthlyRate = interestRate / 100 / 12;
            var numPayments = loanTerm * 12;
            var monthlyPayment = systemCost * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            var totalPayments = monthlyPayment * numPayments;
            interestCost = totalPayments - systemCost;
        }

        var labels = [];
        var values = [];
        var colors = [];

        labels.push('Solar Panels');
        values.push(panelCost);
        colors.push('#60e1e0');

        labels.push('Installation & Project Costs');
        values.push(installCost);
        colors.push('#ffc93c');

        if (batteryCost > 0) {
            labels.push('Battery Storage');
            values.push(batteryCost);
            colors.push('#ff9a76');
        }

        if (interestCost > 0) {
            labels.push('Finance Interest');
            values.push(interestCost);
            colors.push('#9ca3af');
        }

        // Create donut chart
        costBreakdownChartInstance = new Chart(costCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.label || '';
                                var value = context.parsed || 0;
                                var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                                var percentage = ((value / total) * 100).toFixed(1);
                                return label + ': $' + formatNumber(value) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // Display breakdown details
        if (costDetailsDiv) {
            var detailsHtml = '<div style="text-align: center;">';
            detailsHtml += '<strong>Cost Breakdown:</strong><br>';
            for (var i = 0; i < labels.length; i++) {
                detailsHtml += labels[i] + ': $' + formatNumber(values[i]) + '<br>';
            }
            detailsHtml += '</div>';
            costDetailsDiv.innerHTML = detailsHtml;
        }
    }

    // Submit button handler
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();

        // Security: Rate limiting check
        var now = Date.now();
        if (now - lastSubmitTime < SUBMIT_COOLDOWN) {
            var secondsRemaining = Math.ceil((SUBMIT_COOLDOWN - (now - lastSubmitTime)) / 1000);
            alert('Please wait ' + secondsRemaining + ' seconds before submitting again.');
            return;
        }

        // Security: Honeypot check - if these fields are filled/checked, it's a bot
        var agreeToDisagree = document.getElementById('agreeToDisagree').checked;
        var cityField = document.getElementById('city').value.trim();
        var honeypotTimestamp = document.getElementById('honeypotTimestamp').value.trim();

        // Check if honeypot fields are filled OR if form submitted too quickly (< 10 seconds)
        var timeSincePageLoad = now - pageLoadTime;
        if (agreeToDisagree || cityField || honeypotTimestamp || timeSincePageLoad < 10000) {
            // Silently fail for bots
            console.log('Bot detected');
            return;
        }

        var firstName = document.getElementById('firstName').value.trim();
        var lastName = document.getElementById('lastName').value.trim();
        var email = document.getElementById('email').value.trim();
        var phone = document.getElementById('phone').value.trim();

        // Clear all errors first
        document.querySelectorAll('.error-message').forEach(function(el) {
            el.classList.remove('show');
            el.textContent = '';
        });
        document.querySelectorAll('.form-input').forEach(function(input) {
            input.classList.remove('error');
        });

        var errors = {};

        // Validate required fields
        if (!firstName) errors.firstName = "We'd love to know your name!";
        if (!lastName) errors.lastName = "Last name too, please!";

        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            errors.email = "Email is required to submit your request";
        } else if (!emailRegex.test(email)) {
            errors.email = "Please enter a valid email address";
        }

        var nzPhoneRegex = /^(\+64|0)[2-9]\d{7,9}$/;
        var cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
        if (!phone) {
            errors.phone = "Phone number is required";
        } else if (!nzPhoneRegex.test(cleanPhone)) {
            errors.phone = "Please enter a valid NZ phone number (e.g., 021 234 5678)";
        }

        // Validate that results exist before submission
        if (!resultsData) {
            errors.firstName = "Please complete the calculator above before submitting";
        }

        if (Object.keys(errors).length > 0) {
            for (var field in errors) {
                var errorEl = document.getElementById('error-' + field);
                var inputEl = document.getElementById(field);
                if (errorEl) {
                    errorEl.textContent = errors[field];
                    errorEl.classList.add('show');
                }
                if (inputEl) {
                    inputEl.classList.add('error');
                }
            }
            var firstErrorField = Object.keys(errors)[0];
            document.getElementById(firstErrorField).scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // Security: Update last submit time for rate limiting
        lastSubmitTime = now;

        // Security: Sanitize all user inputs before submission
        firstName = sanitizeInput(firstName);
        lastName = sanitizeInput(lastName);
        email = sanitizeInput(email);
        phone = sanitizeInput(phone);

        // Build webhook data - only include customer-provided values
        var webhookData = {
            firstName: firstName,
            lastName: lastName,
            email: email,
            phone: phone,
            submittedAt: new Date().toISOString(),
            calculator_version: CALCULATOR_VERSION,
            calculator_name: CALCULATOR_NAME
        };

        // Add customer input data (not assumptions)
        if (rawValues.householdIncome) webhookData.householdIncome = rawValues.householdIncome;
        if (rawValues.propertyValue) webhookData.propertyValue = rawValues.propertyValue;
        if (rawValues.currentLending) webhookData.currentLending = rawValues.currentLending;

        if (rawValues.expenseAmount) webhookData.expenseAmount = rawValues.expenseAmount;

        var expenseFrequency = document.getElementById('expenseFrequency').value;
        if (expenseFrequency) webhookData.expenseFrequency = expenseFrequency;

        // Only include power bill data if customer actually provided it
        var hasCustomerPowerData = false;
        if (rawValues.summerPowerBill && parseFloat(rawValues.summerPowerBill) > 0) {
            webhookData.summerPowerBill = rawValues.summerPowerBill;
            hasCustomerPowerData = true;
        }
        if (rawValues.winterPowerBill && parseFloat(rawValues.winterPowerBill) > 0) {
            webhookData.winterPowerBill = rawValues.winterPowerBill;
            hasCustomerPowerData = true;
        }

        // Only include kWh data if customer provided it
        var hasCustomerKwhData = false;
        if (rawValues.summerKwh && parseFloat(rawValues.summerKwh) > 0) {
            webhookData.summerKwh = rawValues.summerKwh;
            hasCustomerKwhData = true;
        }
        if (rawValues.winterKwh && parseFloat(rawValues.winterKwh) > 0) {
            webhookData.winterKwh = rawValues.winterKwh;
            hasCustomerKwhData = true;
        }
        if (rawValues.dailyCharge && parseFloat(rawValues.dailyCharge) > 0) {
            webhookData.dailyCharge = rawValues.dailyCharge;
        }

        // Helper function to safely add numeric values to webhook
        function safeAddValue(obj, key, value) {
            if (value !== null && value !== undefined && !isNaN(value) && isFinite(value)) {
                obj[key] = value;
            }
        }

        if (resultsData) {
            // Financial metrics - only if customer provided financial data
            if (resultsData.hasFinancialData) {
                safeAddValue(webhookData, 'lvr', resultsData.lvr);
                webhookData.borrowingPower = resultsData.borrowingPowerText || '';
                webhookData.solarReady = resultsData.solarReady || false;
                safeAddValue(webhookData, 'monthlySurplus', resultsData.monthlySurplus);
            }
            webhookData.calculationMethod = resultsData.calculationMethod || 'expenses';

            // Include power cost estimates (these use customer data even if partly estimated)
            if (hasCustomerPowerData) {
                safeAddValue(webhookData, 'estimatedPowerCost', resultsData.estimatedPowerCost);
            }

            // Include solar savings calculations (based on customer data)
            if (resultsData.annualSolarSavings && parseFloat(resultsData.annualSolarSavings) > 0) {
                safeAddValue(webhookData, 'estimatedSolarSystemCost', resultsData.solarSystemCost);
                safeAddValue(webhookData, 'annualSolarSavings', resultsData.annualSolarSavings);
                safeAddValue(webhookData, 'total25YearSavings', resultsData.total25YearSavings);
            }

            // kWh-based metrics - ONLY if customer provided actual kWh data
            if (hasCustomerKwhData && resultsData.calculationMethod === 'kwh') {
                safeAddValue(webhookData, 'avgMonthlyKwh', resultsData.avgMonthlyKwh);
                safeAddValue(webhookData, 'costPerKwh', resultsData.costPerKwh);
                safeAddValue(webhookData, 'annualUsageCost', resultsData.annualUsageCost);

                // Only include daily charges if customer provided it
                if (webhookData.dailyCharge) {
                    safeAddValue(webhookData, 'annualDailyCharges', resultsData.annualDailyCharges);
                }
            }

            // Financing data (based on customer selections)
            webhookData.isFinanced = resultsData.isFinanced || false;
            if (resultsData.isFinanced) {
                safeAddValue(webhookData, 'loanTerm', resultsData.loanTerm);
                safeAddValue(webhookData, 'interestRate', resultsData.interestRate);
                safeAddValue(webhookData, 'monthlyLoanPayment', resultsData.monthlyLoanPayment);
                safeAddValue(webhookData, 'totalLoanPayments', resultsData.totalLoanPayments);
                safeAddValue(webhookData, 'totalInterestPaid', resultsData.totalInterestPaid);
                safeAddValue(webhookData, 'paybackPeriod', resultsData.paybackPeriod);
            }

            // Panel system data - ONLY if based on real customer kWh data
            if (hasCustomerKwhData && resultsData.calculationMethod === 'kwh') {
                // Panel-only system data
                if (resultsData.panelOnlySystem) {
                    var panelOnly = resultsData.panelOnlySystem;
                    safeAddValue(webhookData, 'panelOnly_monthlyGeneration', panelOnly.monthlyGeneration ? panelOnly.monthlyGeneration.toFixed(0) : null);
                    safeAddValue(webhookData, 'panelOnly_panelCount', panelOnly.panelCount);
                    safeAddValue(webhookData, 'panelOnly_systemKw', panelOnly.systemKw ? panelOnly.systemKw.toFixed(1) : null);
                    safeAddValue(webhookData, 'panelOnly_systemCost', panelOnly.systemCost ? panelOnly.systemCost.toFixed(0) : null);
                    safeAddValue(webhookData, 'panelOnly_monthlySavings', panelOnly.monthlySavings ? panelOnly.monthlySavings.toFixed(0) : null);
                    safeAddValue(webhookData, 'panelOnly_annualSavings', panelOnly.annualSavings ? panelOnly.annualSavings.toFixed(0) : null);
                    safeAddValue(webhookData, 'panelOnly_paybackYears', panelOnly.paybackYears ? panelOnly.paybackYears.toFixed(2) : null);
                    safeAddValue(webhookData, 'panelOnly_25YearSavings', panelOnly.savings25Year ? panelOnly.savings25Year.toFixed(0) : null);
                }

                // Panel + battery system data
                if (resultsData.panelBatterySystem) {
                    var panelBattery = resultsData.panelBatterySystem;
                    safeAddValue(webhookData, 'panelBattery_monthlyGeneration', panelBattery.monthlyGeneration ? panelBattery.monthlyGeneration.toFixed(0) : null);
                    safeAddValue(webhookData, 'panelBattery_panelCount', panelBattery.panelCount);
                    safeAddValue(webhookData, 'panelBattery_systemKw', panelBattery.systemKw ? panelBattery.systemKw.toFixed(1) : null);
                    safeAddValue(webhookData, 'panelBattery_batteryKwh', panelBattery.batteryKwh);
                    safeAddValue(webhookData, 'panelBattery_systemCost', panelBattery.systemCost ? panelBattery.systemCost.toFixed(0) : null);
                    safeAddValue(webhookData, 'panelBattery_monthlySavings', panelBattery.monthlySavings ? panelBattery.monthlySavings.toFixed(0) : null);
                    safeAddValue(webhookData, 'panelBattery_annualSavings', panelBattery.annualSavings ? panelBattery.annualSavings.toFixed(0) : null);
                    safeAddValue(webhookData, 'panelBattery_paybackYears', panelBattery.paybackYears ? panelBattery.paybackYears.toFixed(2) : null);
                    safeAddValue(webhookData, 'panelBattery_25YearSavings', panelBattery.savings25Year ? panelBattery.savings25Year.toFixed(0) : null);
                }
            }

            // Add final system selection (panel-only or panel-battery)
            webhookData.finalSystemSelection = finalSystemSelection;
        }

        // Convert to form data to avoid CORS preflight issues
        var formData = new FormData();
        for (var key in webhookData) {
            if (webhookData.hasOwnProperty(key)) {
                formData.append(key, webhookData[key]);
            }
        }

        // Track form submission in DataLayer
        var submissionEventData = {
            'event': 'form_submitted',
            'calculator_name': CALCULATOR_NAME,
            'calculator_version': CALCULATOR_VERSION,
            'solar_ready': webhookData.solarReady,
            'borrowing_power': webhookData.borrowingPower,
            'is_financed': webhookData.isFinanced,
            'final_system_selection': finalSystemSelection,
            'timestamp': new Date().toISOString()
        };

        // Add power bill data if available
        if (rawValues.summerPowerBill && parseFloat(rawValues.summerPowerBill) > 0) {
            submissionEventData.power_bill_summer = rawValues.summerPowerBill;
        }
        if (rawValues.winterPowerBill && parseFloat(rawValues.winterPowerBill) > 0) {
            submissionEventData.power_bill_winter = rawValues.winterPowerBill;
        }

        // Add kWh data if available
        if (rawValues.summerKwh && parseFloat(rawValues.summerKwh) > 0) {
            submissionEventData.summer_kwh = rawValues.summerKwh;
        }
        if (rawValues.winterKwh && parseFloat(rawValues.winterKwh) > 0) {
            submissionEventData.winter_kwh = rawValues.winterKwh;
        }

        window.dataLayer.push(submissionEventData);

        fetch('https://hooks.zapier.com/hooks/catch/25081790/urfarah/', {
            method: 'POST',
            body: formData
        }).then(function() {
            document.getElementById('contactForm').classList.add('hidden');
            document.getElementById('successMessage').classList.add('show');
        }).catch(function(error) {
            console.error('Error:', error);
            document.getElementById('contactForm').classList.add('hidden');
            document.getElementById('successMessage').classList.add('show');
        });
    });

    // Initialize
    setupInputs();

    // Set calculator version in hidden field for Zapier validation
    var versionField = document.getElementById('calculatorVersion');
    if (versionField) {
        versionField.value = CALCULATOR_NAME;
    }
})();
</script>

</body>
</html>
